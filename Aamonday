*    BREAK-POINT.
    " Fix 1: Applicable CD% validation
    IF gs_credit-applicable_cd_pct > gs_credit-cd_pct.
      gs_credit-applicable_cd_pct = gs_credit-cd_pct.
      gs_credit-applicable_cd_amt = ( gs_credit-payment_amt * gs_credit-cd_pct ) / 100.
    ENDIF.
    IF gs_credit-applicable_cd_pct < 0.
      gs_credit-applicable_cd_pct = 0.
      gs_credit-applicable_cd_amt = 0.
    ENDIF.

    gs_credit-amt_after_cd = gs_credit-payment_amt - gs_credit-applicable_cd_amt.








" Fix 1: Applicable CD% validation after recalc
       IF ls_credit-applicable_cd_pct > ls_credit-cd_pct.
         ls_credit-applicable_cd_pct = ls_credit-cd_pct.
         ls_credit-applicable_cd_amt = ( ls_credit-payment_amt * ls_credit-cd_pct ) / 100.
       ENDIF.
       IF ls_credit-applicable_cd_pct < 0.
         ls_credit-applicable_cd_pct = 0.
         ls_credit-applicable_cd_amt = 0.
       ENDIF.

       " Recalculate Amount After CD
       ls_credit-amt_after_cd = ls_credit-payment_amt - ls_credit-applicable_cd_amt.








WHEN 'SELALL'.
        " Fix 2: Respect ALV filter - only select visible rows
        DATA: lt_filtered_rows TYPE lvc_t_fidx,
              lv_row_index     TYPE i.

        CALL METHOD go_alv_grid->get_filtered_entries
          IMPORTING
            et_filtered_entries = lt_filtered_rows.

        LOOP AT gt_credit INTO ls_credit.
          lv_row_index = sy-tabix.
          " Skip rows that are filtered out (hidden)
          READ TABLE lt_filtered_rows WITH KEY table_line = lv_row_index
            TRANSPORTING NO FIELDS.
          IF sy-subrc = 0.
            CONTINUE.  " This row is filtered out, skip
          ENDIF.
          IF ls_credit-posted <> 'X' AND ls_credit-applicable_cd_amt > 0.
            ls_credit-checkmark = 'X'.
            MODIFY gt_credit FROM ls_credit INDEX lv_row_index.
          ENDIF.
        ENDLOOP.
        CALL METHOD go_alv_grid->refresh_table_display.















WHEN 'DESELALL'.
        " Fix 2: Respect ALV filter for deselect too
        DATA: lt_filtered_desel TYPE lvc_t_fidx,
              lv_desel_index    TYPE i.

        CALL METHOD go_alv_grid->get_filtered_entries
          IMPORTING
            et_filtered_entries = lt_filtered_desel.

        LOOP AT gt_credit INTO ls_credit.
          lv_desel_index = sy-tabix.
          READ TABLE lt_filtered_desel WITH KEY table_line = lv_desel_index
            TRANSPORTING NO FIELDS.
          IF sy-subrc = 0.
            CONTINUE.
          ENDIF.
          ls_credit-checkmark = ' '.
          MODIFY gt_credit FROM ls_credit INDEX lv_desel_index.
        ENDLOOP.
        CALL METHOD go_alv_grid->refresh_table_display.








DATA: lv_count         TYPE i,
          lv_answer        TYPE c,
          lv_message       TYPE char100,
          lv_post_str      TYPE char10,
          lv_error_str     TYPE char10,
          lv_count_str     TYPE char10,
          ls_credit        TYPE ty_credit,
          ls_stable        TYPE lvc_s_stbl,
          lt_filtered_rows TYPE lvc_t_fidx,
          lv_row_index     TYPE i.












WHEN 'SELALL'.
        CLEAR: lt_filtered_rows, lv_row_index.
        CALL METHOD go_alv_grid->get_filtered_entries
          IMPORTING
            et_filtered_entries = lt_filtered_rows.

        LOOP AT gt_credit INTO ls_credit.
          lv_row_index = sy-tabix.
          READ TABLE lt_filtered_rows WITH KEY table_line = lv_row_index
            TRANSPORTING NO FIELDS.
          IF sy-subrc = 0.
            CONTINUE.
          ENDIF.
          IF ls_credit-posted <> 'X' AND ls_credit-applicable_cd_amt > 0.
            ls_credit-checkmark = 'X'.
            MODIFY gt_credit FROM ls_credit INDEX lv_row_index.
          ENDIF.
        ENDLOOP.
        CALL METHOD go_alv_grid->refresh_table_display.












WHEN 'DESELALL'.
        CLEAR: lt_filtered_rows, lv_row_index.
        CALL METHOD go_alv_grid->get_filtered_entries
          IMPORTING
            et_filtered_entries = lt_filtered_rows.

        LOOP AT gt_credit INTO ls_credit.
          lv_row_index = sy-tabix.
          READ TABLE lt_filtered_rows WITH KEY table_line = lv_row_index
            TRANSPORTING NO FIELDS.
          IF sy-subrc = 0.
            CONTINUE.
          ENDIF.
          ls_credit-checkmark = ' '.
          MODIFY gt_credit FROM ls_credit INDEX lv_row_index.
        ENDLOOP.
        CALL METHOD go_alv_grid->refresh_table_display.










METHOD on_toolbar.

    DATA: ls_button TYPE stb_button.

    " Fix 8: Remove standard row manipulation buttons
    DELETE e_object->mt_toolbar WHERE function = '&LOCAL&APPEND'
                                  OR function = '&LOCAL&INSERT_ROW'
                                  OR function = '&LOCAL&DELETE_ROW'
                                  OR function = '&LOCAL&COPY_ROW'
                                  OR function = '&LOCAL&COPY'
                                  OR function = '&LOCAL&CUT'
                                  OR function = '&LOCAL&PASTE'
                                  OR function = '&LOCAL&UNDO'.

    " Add Separator














ENDLOOP.

  " Bulk save ALL processed records to custom table AFTER all posting is done
  IF gt_vendcd_save[] IS NOT INITIAL.
    MODIFY zfi_vendcd_doc FROM TABLE gt_vendcd_save.
    IF sy-subrc = 0.
      COMMIT WORK AND WAIT.
    ELSE.
      ROLLBACK WORK.
    ENDIF.
    CLEAR gt_vendcd_save.
  ENDIF.

ENDFORM.








gs_credit-post_doc_no       = gs_vendcd_doc-post_doc_no.
    gs_credit-post_message      = gs_vendcd_doc-post_message.

    " CD and Clearing fields
    gs_credit-cd_status         = gs_vendcd_doc-cd_status.
    gs_credit-cd_doc            = gs_vendcd_doc-cd_doc.
    gs_credit-clg_status        = gs_vendcd_doc-clg_status.
    gs_credit-clg_doc           = gs_vendcd_doc-clg_doc.
    gs_credit-payment_doc_no    = gs_vendcd_doc-payment_doc_no.
    gs_credit-payment_posted    = gs_vendcd_doc-payment_posted.
    gs_credit-payment_message   = gs_vendcd_doc-payment_message.
    gs_credit-amt_after_cd      = gs_vendcd_doc-amt_after_cd.

    gs_credit-hkont             = gs_vendcd_doc-hkont.











" Skip if fully posted both bapi and bdc.
    IF <fs_credit>-cd_status = 'X' AND <fs_credit>-clg_status = 'X'.
      CONTINUE.
    ENDIF.

    " Validate: Payment Amount must be > 0
    IF <fs_credit>-payment_amt <= 0 OR <fs_credit>-payment_amt IS INITIAL.
      <fs_credit>-post_message = 'Payment Amount is zero/initial'.
      gv_error_count = gv_error_count + 1.
      CONTINUE.
    ENDIF.

    " Validate: Applicable CD Amount must be > 0










WHEN 'PAYMENT_AMT'.
       " Handle PAYMENT_AMT change - Recalculate Applicable CD Amount
       " Validate: Only numeric input allowed
       TRY.
           lv_new_amt = ls_mod_cell-value.
         CATCH cx_sy_conversion_no_number.
           " Invalid input - show error and reset
           CALL METHOD er_data_changed->add_protocol_entry
             EXPORTING
               i_msgid     = '00'
               i_msgno     = '001'
               i_msgty     = 'E'
               i_msgv1     = 'Invalid input. Only'
               i_msgv2     = 'numeric values allowed.'
               i_fieldname = 'PAYMENT_AMT'
               i_row_id    = ls_mod_cell-row_id.
           ls_credit-payment_amt = ls_credit-initial_amt.
           MODIFY gt_credit FROM ls_credit INDEX lv_tabix.
           CONTINUE.
       ENDTRY.















" PAYMENT_DOC_NO - HIDDEN
CLEAR gs_fieldcat.
gs_fieldcat-fieldname = 'PAYMENT_DOC_NO'.
gs_fieldcat-coltext   = 'Payment Doc'.
gs_fieldcat-no_out    = 'X'.
APPEND gs_fieldcat TO gt_fieldcat.

" PAYMENT_POSTED - HIDDEN
CLEAR gs_fieldcat.
gs_fieldcat-fieldname = 'PAYMENT_POSTED'.
gs_fieldcat-coltext   = 'Pmt Posted'.
gs_fieldcat-checkbox  = 'X'.
gs_fieldcat-edit      = ' '.
gs_fieldcat-no_out    = 'X'.
APPEND gs_fieldcat TO gt_fieldcat.

" PAYMENT_MESSAGE - HIDDEN
CLEAR gs_fieldcat.
gs_fieldcat-fieldname = 'PAYMENT_MESSAGE'.
gs_fieldcat-coltext   = 'Payment Status'.
gs_fieldcat-no_out    = 'X'.
APPEND gs_fieldcat TO gt_fieldcat.











ENDLOOP.

  " Delete all fully posted documents from ALV display
  DELETE gt_credit WHERE cd_status  = 'X'
                    AND clg_status = 'X'
                    AND posted     = 'X'.

ENDFORM.





ENDLOOP.

  " Delete all matched posted records from ALV
  " Match criteria: CLG_DOC populated + AMT_AFTER_CD valid + LIFNR present
  DELETE gt_credit WHERE clg_doc    <> space
                    AND amt_after_cd > 0
                    AND lifnr       <> space.

ENDFORM.












FORM fill_created_fields.

  DATA: ls_term TYPE zfi_vendcd_term.

  LOOP AT total INTO ls_term.
    IF ls_term-erdat IS INITIAL.
      ls_term-erdat = sy-datum.
      ls_term-ernam = sy-uname.
      ls_term-aedat = sy-datum.
      ls_term-aenam = sy-uname.
      MODIFY total FROM ls_term.
    ENDIF.
  ENDLOOP.

ENDFORM.

FORM fill_changed_fields.

  DATA: ls_term TYPE zfi_vendcd_term.

  LOOP AT total INTO ls_term WHERE aedat <> sy-datum
                                OR aenam <> sy-uname.
    " Only update changed fields, preserve created fields
    ls_term-aedat = sy-datum.
    ls_term-aenam = sy-uname.
    " Set created fields if blank (for old records)
    IF ls_term-erdat IS INITIAL.
      ls_term-erdat = sy-datum.
      ls_term-ernam = sy-uname.
    ENDIF.
    MODIFY total FROM ls_term.
  ENDLOOP.

ENDFORM.










FORM screen_modify.

  DATA: lv_action TYPE sy-ucomm.
  lv_action = sy-ucomm.

  LOOP AT SCREEN.
    " Gray out key fields on existing records
    IF screen-name CS 'BUKRS'
    OR screen-name CS 'LIFNR'
    OR screen-name CS 'ZP2PDEMANDI'.
      IF lv_action <> 'NEWL' AND lv_action <> 'APTS'.
        screen-input = '0'.
        MODIFY SCREEN.
      ENDIF.
    ENDIF.

    " Always gray out audit fields (auto-populated)
    IF screen-name CS 'ERDAT'
    OR screen-name CS 'ERNAM'
    OR screen-name CS 'AEDAT'
    OR screen-name CS 'AENAM'.
      screen-input = '0'.
      MODIFY SCREEN.
    ENDIF.
  ENDLOOP.

ENDFORM.
