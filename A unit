ELSEIF vbkd-bstkd IS NOT INITIAL.
***BOC--UJWAL--05.02.2026--PO Number Delivery Dropdown
          CLEAR: gv_planned_gi, deliv_ord, sale_ord, ls_fval.
          CLEAR: gt_del_wadat, gt_lips_del.
          REFRESH: gt_del_wadat, gt_lips_del, lt_fval.

          " Step 1: Try LIPS (SAP PO as VGBEL)
          SELECT DISTINCT vbeln
            FROM lips
            INTO TABLE gt_lips_del
            WHERE vgbel = vbkd-bstkd.

          IF sy-subrc = 0 AND gt_lips_del IS NOT INITIAL.
            " Step 2: Get WADAT from LIKP
            SELECT vbeln wadat
              FROM likp
              INTO TABLE gt_del_wadat
              FOR ALL ENTRIES IN gt_lips_del
              WHERE vbeln = gt_lips_del-vbeln.

            IF sy-subrc = 0 AND gt_del_wadat IS NOT INITIAL.
              SORT gt_del_wadat BY vbeln.
              DELETE ADJACENT DUPLICATES FROM gt_del_wadat COMPARING vbeln.

              READ TABLE gt_del_wadat INTO gs_del_wadat INDEX 1.
              IF sy-subrc = 0.
                gv_planned_gi = gs_del_wadat-wadat.
                lv_delivery = gs_del_wadat-vbeln.
                deliv_ord = gs_del_wadat-vbeln.

                " Step 3: Get Sales Order from VBFA using Delivery
                SELECT SINGLE vbelv
                  FROM vbfa INTO sale_ord
                  WHERE vbeln = gs_del_wadat-vbeln
                  AND vbtyp_v = 'C'.
              ENDIF.

              " Populate dropdown
              LOOP AT gt_del_wadat INTO gs_del_wadat.
                ls_fval-key  = gs_del_wadat-vbeln.
                ls_fval-text = gs_del_wadat-vbeln.
                APPEND ls_fval TO lt_fval.
              ENDLOOP.

              CALL FUNCTION 'VRM_SET_VALUES'
                EXPORTING
                  id     = 'DELIV_ORD'
                  values = lt_fval.
            ENDIF.
          ENDIF.

          " Fallback: If no delivery found in LIPS
          IF gt_del_wadat IS INITIAL.
            CLEAR: gt_del_wadat, gt_lips_del, deliv_ord.
            REFRESH: lt_fval.

            CALL FUNCTION 'VRM_SET_VALUES'
              EXPORTING
                id     = 'DELIV_ORD'
                values = lt_fval.

            SELECT SINGLE vbeln
              FROM vbkd INTO lv_ord
              WHERE bstkd = vbkd-bstkd.

            IF sy-subrc = 0.
              wa_ysdssop-sales_order = lv_ord.
              sale_ord = lv_ord.

              SELECT SINGLE vbeln
                FROM vbfa INTO lv_delivery
                WHERE vbelv = lv_ord
                AND vbtyp_n = 'J'.

              IF sy-subrc = 0 AND lv_delivery IS NOT INITIAL.
                SELECT SINGLE wadat
                  FROM likp INTO gv_planned_gi
                  WHERE vbeln = lv_delivery.
              ENDIF.
            ENDIF.
          ENDIF.
***EOC--UJWAL--05.02.2026--PO Number Delivery Dropdown













ELSEIF vbkd-bstkd IS NOT INITIAL.
***BOC--UJWAL--05.02.2026--PO Number Delivery Dropdown
          CLEAR: gv_planned_gi, gt_del_wadat, gt_lips_del, deliv_ord, sale_ord.

          " Step 1: Try LIPS (SAP PO as VGBEL)
          SELECT DISTINCT vbeln
            FROM lips
            INTO TABLE gt_lips_del
            WHERE vgbel = vbkd-bstkd.

          IF sy-subrc = 0 AND gt_lips_del IS NOT INITIAL.
            " Step 2: Get WADAT from LIKP
            SELECT vbeln wadat
              FROM likp
              INTO TABLE gt_del_wadat
              FOR ALL ENTRIES IN gt_lips_del
              WHERE vbeln = gt_lips_del-vbeln.

            IF sy-subrc = 0 AND gt_del_wadat IS NOT INITIAL.
              SORT gt_del_wadat BY vbeln.
              DELETE ADJACENT DUPLICATES FROM gt_del_wadat COMPARING vbeln.

              READ TABLE gt_del_wadat INTO gs_del_wadat INDEX 1.
              IF sy-subrc = 0.
                gv_planned_gi = gs_del_wadat-wadat.
                lv_del = gs_del_wadat-vbeln.
                deliv_ord = gs_del_wadat-vbeln.

                " Step 3: Get Sales Order from VBFA using Delivery
                SELECT SINGLE vbelv
                  FROM vbfa INTO sale_ord
                  WHERE vbeln = gs_del_wadat-vbeln
                  AND vbtyp_v = 'C'.
              ENDIF.
            ENDIF.
          ELSE.
            " Fallback: VBKD logic
            CLEAR: gt_del_wadat, gt_lips_del, deliv_ord.
            SELECT SINGLE vbeln
              FROM vbkd INTO lv_ord
              WHERE bstkd = vbkd-bstkd.
            IF sy-subrc = 0.
              sale_ord = lv_ord.
              SELECT SINGLE vbeln
                FROM vbfa INTO lv_del
                WHERE vbelv = lv_ord
                AND vbtyp_n = 'J'.
              IF sy-subrc = 0 AND lv_del IS NOT INITIAL.
                SELECT SINGLE wadat
                  FROM likp INTO gv_planned_gi
                  WHERE vbeln = lv_del.
              ENDIF.
            ENDIF.
          ENDIF.
***EOC--UJWAL--05.02.2026--PO Number Delivery Dropdown












*BOC--UJWAL--05.02.2026--Delivery Dropdown Handler for PO
  " Handle Delivery dropdown change for PO Number
  IF vbkd-bstkd IS NOT INITIAL.
    IF deliv_ord IS NOT INITIAL AND gt_del_wadat IS NOT INITIAL.
      CLEAR gs_del_wadat.
      READ TABLE gt_del_wadat INTO gs_del_wadat
        WITH KEY vbeln = deliv_ord.
      IF sy-subrc = 0.
        gv_planned_gi = gs_del_wadat-wadat.
        
        " Also update Sales Order for selected delivery
        SELECT SINGLE vbelv
          FROM vbfa INTO sale_ord
          WHERE vbeln = deliv_ord
          AND vbtyp_v = 'C'.
      ENDIF.
    ENDIF.
  ENDIF.
*EOC--UJWAL--05.02.2026--Delivery Dropdown Handler for PO
```

---

## Summary of Missing Pieces

| Issue | Root Cause | Fix |
|-------|------------|-----|
| Sales Document not showing | VBFA SELECT missing in LIPS path | Add VBFA SELECT after getting delivery |
| Planned GI Date not showing | WADAT empty in LIKP | Maintain data in LIKP |
| Dropdown change doesn't update Sales Doc | Handler missing VBFA SELECT | Add VBFA SELECT in handler |

---

## Complete Flow After Fix
```
PO Number
    ↓
LIPS (VGBEL = PO)
    ↓
Delivery Numbers (gt_lips_del)
    ↓
LIKP (FOR ALL ENTRIES) → WADAT → gv_planned_gi ✅
    ↓
VBFA (vbeln = delivery, vbtyp_v = 'C') → Sales Order → sale_ord ✅
    ↓
Dropdown populated ✅
    ↓
On dropdown change → Update WADAT + Sales Order ✅






















*&---------------------------------------------------------------------*
*& Form FETCH_POSTED_DATA
*&---------------------------------------------------------------------*
*& Fetch already posted documents from ZFI_VENDCD_DOC
*&---------------------------------------------------------------------*
FORM fetch_posted_data.

  DATA: lv_vendor_name TYPE lfa1-name1,
        lt_cellstyle   TYPE lvc_t_styl,
        ls_cellstyle   TYPE lvc_s_styl.

  " Clear all internal tables
  CLEAR: gt_credit, gt_vendcd_doc, gt_lfa1.
  REFRESH: gt_credit, gt_vendcd_doc, gt_lfa1.

  " Fetch Posted Documents from ZFI_VENDCD_DOC
  SELECT *
    FROM zfi_vendcd_doc
    INTO TABLE gt_vendcd_doc
    WHERE bukrs = p_bukrs
      AND lifnr IN s_zp2pde
      AND budat = p_budat
      AND gsber IN s_destpl
      AND zp2pdemandi IN s_zp2p
      AND rebzg IN s_trno
      AND posted = 'X'.

  IF gt_vendcd_doc[] IS INITIAL.
    CLEAR gv_data_fetched.
    MESSAGE 'No posted documents found for selection criteria' TYPE 'S'.
    RETURN.
  ENDIF.

  " Fetch Vendor Names
  SELECT lifnr name1
    FROM lfa1
    INTO CORRESPONDING FIELDS OF TABLE gt_lfa1
    FOR ALL ENTRIES IN gt_vendcd_doc
    WHERE lifnr = gt_vendcd_doc-lifnr.

  SORT gt_lfa1 BY lifnr.

  " Build Output Table from Posted Documents
  LOOP AT gt_vendcd_doc INTO gs_vendcd_doc.
    CLEAR gs_credit.

    " Map fields from ZFI_VENDCD_DOC to ty_credit
    gs_credit-checkmark         = gs_vendcd_doc-checkmark.
    gs_credit-manual_edit       = gs_vendcd_doc-manual_edit.
    gs_credit-payment_reason    = gs_vendcd_doc-payment_reason.
    gs_credit-bukrs             = gs_vendcd_doc-bukrs.
    gs_credit-zp2pdemandi       = gs_vendcd_doc-zp2pdemandi.
    gs_credit-lifnr             = gs_vendcd_doc-lifnr.
    
    " Get Vendor Name
    READ TABLE gt_lfa1 INTO gs_lfa1 WITH KEY lifnr = gs_vendcd_doc-lifnr BINARY SEARCH.
    IF sy-subrc = 0.
      gs_credit-vendor_name = gs_lfa1-name1.
    ELSE.
      gs_credit-vendor_name = gs_vendcd_doc-vendor_name.
    ENDIF.

    gs_credit-gjahr             = gs_vendcd_doc-gjahr.
    gs_credit-belnr             = gs_vendcd_doc-belnr.
    gs_credit-buzei             = gs_vendcd_doc-buzei.
    gs_credit-budat             = gs_vendcd_doc-budat.
    gs_credit-bldat             = gs_vendcd_doc-bldat.
    gs_credit-gsber             = gs_vendcd_doc-gsber.
    gs_credit-waers             = gs_vendcd_doc-waers.
    gs_credit-wrbtr             = gs_vendcd_doc-wrbtr.
    gs_credit-skfbt             = gs_vendcd_doc-skfbt.
    gs_credit-payment_term      = gs_vendcd_doc-payment_term.
    gs_credit-payment_amt       = gs_vendcd_doc-payment_amt.
    
    " *** CORRECTED FIELD NAMES ***
    gs_credit-cd_pct            = gs_vendcd_doc-cd_percent.      " cd_percent (table) -> cd_pct (ALV)
    gs_credit-cd_days           = gs_vendcd_doc-cddays.          " cddays (table) -> cd_days (ALV)
    gs_credit-grace_days        = gs_vendcd_doc-grace_days.
    gs_credit-net_days          = gs_vendcd_doc-net_days.
    gs_credit-applicable_cd_pct = gs_vendcd_doc-applicable_cd_pc. " applicable_cd_pc (table) -> applicable_cd_pct (ALV)
    gs_credit-applicable_cd_amt = gs_vendcd_doc-applicable_cd_am. " applicable_cd_am (table) -> applicable_cd_amt (ALV)
    
    gs_credit-rebzg             = gs_vendcd_doc-rebzg.
    gs_credit-rebzj             = gs_vendcd_doc-rebzj.
    gs_credit-rebzz             = gs_vendcd_doc-rebzz.
    gs_credit-debit_note_no     = gs_vendcd_doc-debit_note_no.
    gs_credit-payment_date      = gs_vendcd_doc-payment_date.
    gs_credit-posted            = gs_vendcd_doc-posted.
    gs_credit-post_doc_no       = gs_vendcd_doc-post_doc_no.
    gs_credit-post_message      = gs_vendcd_doc-post_message.
    gs_credit-hkont             = gs_vendcd_doc-hkont.
    gs_credit-kostl             = gs_vendcd_doc-kostl.
    gs_credit-prctr             = gs_vendcd_doc-prctr.
    gs_credit-mwskz             = gs_vendcd_doc-mwskz.
    
    " TR_NO - Extract first 10 chars from REBZG
    gs_credit-tr_no = gs_vendcd_doc-rebzg(10).
    
    " Initial amount (same as payment amount for posted docs)
    gs_credit-initial_amt = gs_vendcd_doc-payment_amt.
    
    " Calculate zfbdt_days (days from baseline date to today)
    " Note: ZFBDT in table is DEC(3), which seems wrong, but we'll work with it
    " gs_credit-zfbdt_days = sy-datum - gs_vendcd_doc-zfbdt.  " Won't work if ZFBDT is DEC
    gs_credit-zfbdt_days = gs_vendcd_doc-zfbdt_days.  " Use stored value
    
    " Amount After CD
    gs_credit-amt_after_cd = gs_vendcd_doc-payment_amt - gs_vendcd_doc-applicable_cd_am.
    IF gs_credit-amt_after_cd < 0.
      gs_credit-amt_after_cd = 0.
    ENDIF.

    " Disable all editing for posted documents
    CLEAR lt_cellstyle.
    REFRESH lt_cellstyle.

    CLEAR ls_cellstyle.
    ls_cellstyle-fieldname = 'CHECKMARK'.
    ls_cellstyle-style     = cl_gui_alv_grid=>mc_style_disabled.
    APPEND ls_cellstyle TO lt_cellstyle.

    CLEAR ls_cellstyle.
    ls_cellstyle-fieldname = 'MANUAL_EDIT'.
    ls_cellstyle-style     = cl_gui_alv_grid=>mc_style_disabled.
    APPEND ls_cellstyle TO lt_cellstyle.

    CLEAR ls_cellstyle.
    ls_cellstyle-fieldname = 'PAYMENT_AMT'.
    ls_cellstyle-style     = cl_gui_alv_grid=>mc_style_disabled.
    APPEND ls_cellstyle TO lt_cellstyle.

    gs_credit-celltab = lt_cellstyle.

    APPEND gs_credit TO gt_credit.
  ENDLOOP.

  " Set data fetched flag
  IF gt_credit[] IS NOT INITIAL.
    gv_data_fetched = 'X'.
  ELSE.
    CLEAR gv_data_fetched.
    MESSAGE 'No posted documents to display' TYPE 'S'.
  ENDIF.

ENDFORM.

































WHEN 'PAYMENT_AMT'.
  " Handle PAYMENT_AMT change - Recalculate Applicable CD Amount
  lv_new_amt = ls_mod_cell-value.

  " VALIDATION: Payment Amount cannot exceed Initial Amount
  IF lv_new_amt > ls_credit-initial_amt.
    " Show error and reset to initial amount
    CALL METHOD er_data_changed->add_protocol_entry
      EXPORTING
        i_msgid     = '00'
        i_msgno     = '001'
        i_msgty     = 'E'
        i_msgv1     = 'Payment Amount cannot exceed'
        i_msgv2     = 'Initial Amount'
        i_fieldname = 'PAYMENT_AMT'
        i_row_id    = ls_mod_cell-row_id.

    " Reset to initial amount
    ls_credit-payment_amt = ls_credit-initial_amt.
  ELSE.
    ls_credit-payment_amt = lv_new_amt.
  ENDIF.

  " Recalculate Applicable CD Amount based on new Payment Amount
  PERFORM calculate_applicable_cd
    USING    ls_credit-zfbdt
             ls_credit-cd_days
             ls_credit-grace_days
             ls_credit-cd_pct
             ls_credit-cd_pct
             lv_new_amt
             ls_credit-net_days
    CHANGING ls_credit-applicable_cd_pct
             ls_credit-applicable_cd_amt.

  " Recalculate Amount After CD
  ls_credit-amt_after_cd = ls_credit-payment_amt - ls_credit-applicable_cd_amt.
  IF ls_credit-amt_after_cd < 0.
    ls_credit-amt_after_cd = 0.
  ENDIF.

  " *** FIX: Keep PAYMENT_AMT editable if MANUAL_EDIT is checked ***
  CLEAR lt_celltab.
  REFRESH lt_celltab.

  " PAYMENT_AMT style - remains editable if manual_edit = X
  CLEAR ls_celltab.
  ls_celltab-fieldname = 'PAYMENT_AMT'.
  IF ls_credit-manual_edit = 'X'.
    ls_celltab-style = cl_gui_alv_grid=>mc_style_enabled.
  ELSE.
    ls_celltab-style = cl_gui_alv_grid=>mc_style_disabled.
  ENDIF.
  INSERT ls_celltab INTO TABLE lt_celltab.

  " Keep CHECKMARK disabled if no CD applicable or already posted
  IF ls_credit-applicable_cd_amt <= 0 OR ls_credit-posted = 'X'.
    CLEAR ls_celltab.
    ls_celltab-fieldname = 'CHECKMARK'.
    ls_celltab-style     = cl_gui_alv_grid=>mc_style_disabled.
    INSERT ls_celltab INTO TABLE lt_celltab.
  ENDIF.

  " Keep MANUAL_EDIT disabled if already posted
  IF ls_credit-posted = 'X'.
    CLEAR ls_celltab.
    ls_celltab-fieldname = 'MANUAL_EDIT'.
    ls_celltab-style     = cl_gui_alv_grid=>mc_style_disabled.
    INSERT ls_celltab INTO TABLE lt_celltab.
  ENDIF.

  ls_credit-celltab = lt_celltab.

  MODIFY gt_credit FROM ls_credit INDEX lv_tabix.


























*&---------------------------------------------------------------------*
*& Form CALL_BDC_VENDOR_CLEARING
*&---------------------------------------------------------------------*
FORM call_bdc_vendor_clearing
  USING    ps_credit      TYPE ty_credit
           pv_debit_doc   TYPE belnr_d
  CHANGING pv_clear_doc   TYPE belnr_d
           pv_message     TYPE char100
           pv_success     TYPE char1.

  " BDC Data
  DATA: lt_bdcdata TYPE STANDARD TABLE OF bdcdata,
        ls_bdcdata TYPE bdcdata.

  " Messages
  DATA: lt_messtab TYPE STANDARD TABLE OF bdcmsgcoll,
        ls_messtab TYPE bdcmsgcoll.

  " Local variables
  DATA: lv_vendor       TYPE char10,
        lv_bukrs        TYPE char4,
        lv_budat        TYPE char10,
        lv_monat        TYPE char2,
        lv_waers        TYPE char5,
        lv_amt_after_cd TYPE char20,
        lv_inv_doc      TYPE char30,
        lv_dn_doc       TYPE char30,
        lv_residual     TYPE bsik-wrbtr,
        lv_belnr        TYPE belnr_d.

  " Clear
  CLEAR: lt_bdcdata, lt_messtab, pv_clear_doc, pv_message, pv_success.
  REFRESH: lt_bdcdata, lt_messtab.

  "------------------------------------------------------------
  " Prepare Field Values
  "------------------------------------------------------------
  " Vendor (with leading zeros)
  lv_vendor = ps_credit-lifnr.
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      input  = lv_vendor
    IMPORTING
      output = lv_vendor.

  " Company Code
  lv_bukrs = ps_credit-bukrs.

  " Posting Date (DD.MM.YYYY)
  WRITE sy-datum TO lv_budat DD/MM/YYYY.

  " Period (MM)
  lv_monat = sy-datum+4(2).

  " Currency
  lv_waers = ps_credit-waers.

  " Original Invoice Document
  lv_inv_doc = ps_credit-belnr.
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      input  = lv_inv_doc
    IMPORTING
      output = lv_inv_doc.

  " Debit Note Document
  lv_dn_doc = pv_debit_doc.
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      input  = lv_dn_doc
    IMPORTING
      output = lv_dn_doc.

  " Calculate residual amount (Payment Amt - CD Amt)
  lv_residual = ps_credit-payment_amt - ps_credit-applicable_cd_amt.
  
  " Format amount without thousand separator, with negative sign at end
  WRITE lv_residual TO lv_amt_after_cd NO-GROUPING.
  CONDENSE lv_amt_after_cd NO-GAPS.
  CONCATENATE lv_amt_after_cd '-' INTO lv_amt_after_cd.

  "------------------------------------------------------------
  " Screen 1: SAPMF05A / 0131 - Initial Selection
  "------------------------------------------------------------
  PERFORM bdc_dynpro USING 'SAPMF05A' '0131'
                     CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_CURSOR'
                          'RF05A-XPOS1(03)'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_OKCODE'
                          '/00'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'RF05A-AGKON'
                          lv_vendor
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BKPF-BUDAT'
                          lv_budat
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BKPF-MONAT'
                          lv_monat
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BKPF-BUKRS'
                          lv_bukrs
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BKPF-WAERS'
                          lv_waers
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'RF05A-XNOPS'
                          'X'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'RF05A-XPOS1(01)'
                          'X'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'RF05A-XPOS1(03)'
                          'X'
                    CHANGING lt_bdcdata.

  "------------------------------------------------------------
  " Screen 2: SAPMF05A / 0731 - Document Selection (Enter)
  "------------------------------------------------------------
  PERFORM bdc_dynpro USING 'SAPMF05A' '0731'
                     CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_CURSOR'
                          'RF05A-SEL01(02)'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_OKCODE'
                          '/00'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'RF05A-SEL01(01)'
                          lv_inv_doc
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'RF05A-SEL01(02)'
                          lv_dn_doc
                    CHANGING lt_bdcdata.

  "------------------------------------------------------------
  " Screen 3: SAPMF05A / 0731 - Process Open Items
  "------------------------------------------------------------
  PERFORM bdc_dynpro USING 'SAPMF05A' '0731'
                     CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_CURSOR'
                          'RF05A-SEL01(01)'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_OKCODE'
                          '=PA'
                    CHANGING lt_bdcdata.

  "------------------------------------------------------------
  " Screen 4: SAPDF05X / 3100 - Residual Items
  "------------------------------------------------------------
  PERFORM bdc_dynpro USING 'SAPDF05X' '3100'
                     CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_OKCODE'
                          '=REST'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_CURSOR'
                          'DF05B-PSSKT(01)'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'RF05A-ABPOS'
                          '1'
                    CHANGING lt_bdcdata.

  "------------------------------------------------------------
  " Screen 5: SAPDF05X / 3100 - Enter Difference Amount
  "------------------------------------------------------------
  PERFORM bdc_dynpro USING 'SAPDF05X' '3100'
                     CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_OKCODE'
                          '/00'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_CURSOR'
                          'DF05B-PSDIF(01)'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'RF05A-ABPOS'
                          '1'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'DF05B-PSDIF(01)'
                          lv_amt_after_cd
                    CHANGING lt_bdcdata.

  "------------------------------------------------------------
  " Screen 6: SAPDF05X / 3100 - Process Items (=PI)
  "------------------------------------------------------------
  PERFORM bdc_dynpro USING 'SAPDF05X' '3100'
                     CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_OKCODE'
                          '=PI'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_CURSOR'
                          'RF05A-AKOBT'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'RF05A-ABPOS'
                          '1'
                    CHANGING lt_bdcdata.

  "------------------------------------------------------------
  " Screen 7: SAPDF05X / 3100 - Post Document
  "------------------------------------------------------------
  PERFORM bdc_dynpro USING 'SAPDF05X' '3100'
                     CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_OKCODE'
                          '=BU'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'BDC_CURSOR'
                          'RF05A-AKOBT'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'RF05A-ABPOS'
                          '1'
                    CHANGING lt_bdcdata.

  PERFORM bdc_field USING 'RF05A-AKOBT'
                          'CD Clearing'
                    CHANGING lt_bdcdata.

  "------------------------------------------------------------
  " Call Transaction F-44
  "------------------------------------------------------------
  CALL TRANSACTION 'F-44'
    USING lt_bdcdata
    MODE 'N'
    UPDATE 'S'
    MESSAGES INTO lt_messtab.

  "------------------------------------------------------------
  " Process Messages
  "------------------------------------------------------------
  LOOP AT lt_messtab INTO ls_messtab
    WHERE msgtyp = 'S'.

    " Document posted message
    IF ( ls_messtab-msgid = 'F5' AND ls_messtab-msgnr = '312' ) OR
       ( ls_messtab-msgid = 'F5' AND ls_messtab-msgnr = '313' ) OR
       ( ls_messtab-msgid = 'FP' AND ls_messtab-msgnr = '001' ).

      " Extract document number
      lv_belnr = ls_messtab-msgv1.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = lv_belnr
        IMPORTING
          output = pv_clear_doc.

      CONCATENATE 'Clearing Doc' pv_clear_doc 'posted'
        INTO pv_message SEPARATED BY space.
      pv_success = 'X'.
      EXIT.
    ENDIF.
  ENDLOOP.

  " If no success, check for errors
  IF pv_success <> 'X'.
    LOOP AT lt_messtab INTO ls_messtab
      WHERE msgtyp = 'E' OR msgtyp = 'A'.

      CALL FUNCTION 'MESSAGE_TEXT_BUILD'
        EXPORTING
          msgid               = ls_messtab-msgid
          msgnr               = ls_messtab-msgnr
          msgv1               = ls_messtab-msgv1
          msgv2               = ls_messtab-msgv2
          msgv3               = ls_messtab-msgv3
          msgv4               = ls_messtab-msgv4
        IMPORTING
          message_text_output = pv_message.

      pv_success = ' '.
      EXIT.
    ENDLOOP.

    IF pv_message IS INITIAL.
      pv_message = 'F-44 Clearing failed'.
      pv_success = ' '.
    ENDIF.
  ENDIF.

ENDFORM.



















"  Check if Already Posted - Validate LIFNR, DOC NO, and AMOUNT
    CLEAR gs_vendcd_doc.
    READ TABLE gt_vendcd_doc INTO gs_vendcd_doc
      WITH KEY bukrs = gs_bsik_temp-bukrs
               belnr = gs_bsik_temp-belnr
               gjahr = gs_bsik_temp-gjahr
               buzei = gs_bsik_temp-buzei.

IF sy-subrc = 0.
  " Fully posted with matching LIFNR and Amount - DELETE from ALV
  IF gs_vendcd_doc-cd_status = 'X' AND 
     gs_vendcd_doc-clg_status = 'X' AND
     gs_vendcd_doc-lifnr = gs_bsik_temp-lifnr AND
     gs_vendcd_doc-wrbtr = gs_bsik_temp-wrbtr.
    " Match found - Skip this document completely
    CONTINUE.
    
  ELSEIF gs_vendcd_doc-cd_status = 'X' AND gs_vendcd_doc-clg_status <> 'X'.
    " BAPI done, BDC pending - allow retry
    gs_credit-posted       = ' '.
    gs_credit-cd_status    = 'X'.
    gs_credit-cd_doc       = gs_vendcd_doc-cd_doc.
    gs_credit-clg_status   = ' '.
    gs_credit-post_message = 'BDC Pending - Retry'.
  ENDIF.
ELSE.
  gs_credit-posted = ' '.
  CLEAR gs_credit-post_message.
ENDIF.

