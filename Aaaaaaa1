1" Filter by Mandi Selection
      IF s_zp2p[] IS NOT INITIAL.
        CHECK lv_mandi IN s_zp2p.
      ENDIF.

      " ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      " Get CD Terms from ZFI_VENDCD_TERM with format conversion
      " ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      DATA: lv_lifnr_in  TYPE lifnr,
            lv_lifnr_out TYPE lifnr.

      CLEAR: gs_vendcd_term, lv_cd_pct, lv_cd_days, lv_grace_days, lv_net_days.

      " Prepare both vendor formats
      lv_lifnr_in = gs_bsik_temp-lifnr.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = lv_lifnr_in
        IMPORTING
          output = lv_lifnr_in.

      lv_lifnr_out = gs_bsik_temp-lifnr.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          input  = lv_lifnr_out
        IMPORTING
          output = lv_lifnr_out.

      " Try Priority 1: Internal format (with zeros)
      READ TABLE gt_vendcd_term INTO gs_vendcd_term
        WITH KEY bukrs       = gs_bsik_temp-bukrs
                 lifnr       = lv_lifnr_in
                 zp2pdemandi = lv_mandi
        BINARY SEARCH.

      IF sy-subrc <> 0.
        " Try Priority 2: External format (without zeros)
        READ TABLE gt_vendcd_term INTO gs_vendcd_term
          WITH KEY bukrs       = gs_bsik_temp-bukrs
                   lifnr       = lv_lifnr_out
                   zp2pdemandi = lv_mandi
          BINARY SEARCH.
      ENDIF.

      IF sy-subrc = 0.
        " Found vendor-specific terms
        lv_cd_pct     = gs_vendcd_term-cd_percent.
        lv_cd_days    = gs_vendcd_term-cd_days.
        lv_grace_days = gs_vendcd_term-grace_days.
        lv_net_days   = gs_vendcd_term-net_days.
      ELSE.
        " Try Priority 3: Mandi-level (blank vendor)
        LOOP AT gt_vendcd_term INTO gs_vendcd_term
          WHERE bukrs       = gs_bsik_temp-bukrs
            AND zp2pdemandi = lv_mandi
            AND lifnr       = ''.
          EXIT.
        ENDLOOP.

        IF sy-subrc = 0.
          lv_cd_pct     = gs_vendcd_term-cd_percent.
          lv_cd_days    = gs_vendcd_term-cd_days.
          lv_grace_days = gs_vendcd_term-grace_days.
          lv_net_days   = gs_vendcd_term-net_days.
        ELSE.
          " No CD terms found - skip
          CONTINUE.
        ENDIF.
      ENDIF.

      " Continue with rest of processing...
      " Get Payment Reason
      READ TABLE gt_bseg INTO gs_bseg
        WITH KEY bukrs = gs_bsik_temp-bukrs
                 belnr = gs_bsik_temp-belnr
                 gjahr = gs_bsik_temp-gjahr
                 buzei = gs_bsik_temp-buzei
        BINARY SEARCH.
```

---

## üéØ **ACTION PLAN:**

### **Step 1: Update Code**
‚úÖ Change SELECT to fetch all terms for company  
‚úÖ Add dual-format lookup logic  

### **Step 2: Add Table Entry**
‚úÖ Add entry with LIFNR = '0000000P06'  
‚úÖ Verify MANDI = '0101013147'  
‚úÖ Verify ACTIVE = 'X'  

### **Step 3: Test**
‚úÖ Run program  
‚úÖ Check if data appears in ALV  

---

## üí° **WHY THIS WILL WORK:**
```
Before:
BSIK.LIFNR = '0000000P06'
Table.LIFNR = 'P006'
‚Üí NO MATCH ‚ùå

After:
Program tries BOTH:
  1. '0000000P06' ‚úì Matches table entry
  2. 'P006' ‚úì Also matches table entry
‚Üí MATCH FOUND ‚úÖ












*----------------------------------------------------------------------*
* Get CD Terms from ZFI_VENDCD_TERM
* Priority 1: BUKRS + LIFNR (with zeros) + ZP2PDEMANDI
* Priority 2: BUKRS + ZP2PDEMANDI (blank vendor = mandi-level)
*----------------------------------------------------------------------*
DATA: lv_lifnr_alpha TYPE lifnr.

CLEAR: gs_vendcd_term, lv_cd_pct, lv_cd_days, lv_grace_days, lv_net_days.

" Convert vendor to internal format (with leading zeros)
" Example: 5001 ‚Üí 0000005001
lv_lifnr_alpha = gs_bsik_temp-lifnr.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
  EXPORTING
    input  = lv_lifnr_alpha
  IMPORTING
    output = lv_lifnr_alpha.

" PRIORITY 1: Try BUKRS + LIFNR + ZP2PDEMANDI (vendor-specific)
READ TABLE gt_vendcd_term INTO gs_vendcd_term
  WITH KEY bukrs       = gs_bsik_temp-bukrs
           lifnr       = lv_lifnr_alpha
           zp2pdemandi = lv_mandi
  BINARY SEARCH.

IF sy-subrc = 0.
  " Found vendor + mandi specific terms
  lv_cd_pct     = gs_vendcd_term-cd_percent.
  lv_cd_days    = gs_vendcd_term-cd_days.
  lv_grace_days = gs_vendcd_term-grace_days.
  lv_net_days   = gs_vendcd_term-net_days.

ELSE.
  " PRIORITY 2: Try BUKRS + ZP2PDEMANDI only (mandi-level, blank vendor)
  CLEAR gs_vendcd_term.
  LOOP AT gt_vendcd_term INTO gs_vendcd_term
    WHERE bukrs       = gs_bsik_temp-bukrs
      AND zp2pdemandi = lv_mandi
      AND lifnr       = space.    " Blank vendor = mandi-level default
    EXIT.  " Take first match
  ENDLOOP.

  IF sy-subrc = 0.
    " Found mandi-level terms
    lv_cd_pct     = gs_vendcd_term-cd_percent.
    lv_cd_days    = gs_vendcd_term-cd_days.
    lv_grace_days = gs_vendcd_term-grace_days.
    lv_net_days   = gs_vendcd_term-net_days.
  ELSE.
    " No CD terms found - skip this document
    CONTINUE.
  ENDIF.






















*----------------------------------------------------------------------*
* Get CD Terms from ZFI_VENDCD_TERM
* Key: BUKRS + ZP2PDEMANDI + LIFNR
*----------------------------------------------------------------------*
DATA: lv_lifnr_alpha TYPE lifnr,
      lv_lifnr_num   TYPE n LENGTH 10.

CLEAR: gs_vendcd_term, lv_cd_pct, lv_cd_days, lv_grace_days, lv_net_days.

" Convert vendor to internal format with leading zeros
" Example: 5001 ‚Üí 0000005001
lv_lifnr_num   = gs_bsik_temp-lifnr.
lv_lifnr_alpha = lv_lifnr_num.

" PRIORITY 1: BUKRS + ZP2PDEMANDI + LIFNR (vendor-specific)
READ TABLE gt_vendcd_term INTO gs_vendcd_term
  WITH KEY bukrs       = gs_bsik_temp-bukrs
           zp2pdemandi = lv_mandi
           lifnr       = lv_lifnr_alpha
  BINARY SEARCH.

IF sy-subrc = 0.
  " Found vendor + mandi specific terms
  lv_cd_pct     = gs_vendcd_term-cd_percent.
  lv_cd_days    = gs_vendcd_term-cd_days.
  lv_grace_days = gs_vendcd_term-grace_days.
  lv_net_days   = gs_vendcd_term-net_days.

ELSE.
  " PRIORITY 2: BUKRS + ZP2PDEMANDI only (blank vendor)
  CLEAR gs_vendcd_term.
  READ TABLE gt_vendcd_term INTO gs_vendcd_term
    WITH KEY bukrs       = gs_bsik_temp-bukrs
             zp2pdemandi = lv_mandi
             lifnr       = space
    BINARY SEARCH.

  IF sy-subrc = 0.
    lv_cd_pct     = gs_vendcd_term-cd_percent.
    lv_cd_days    = gs_vendcd_term-cd_days.
    lv_grace_days = gs_vendcd_term-grace_days.
    lv_net_days   = gs_vendcd_term-net_days.
  ELSE.
    " No CD terms found - skip this document
    CONTINUE.
  ENDIF.

ENDIF.
ENDIF.








IF gt_bsik_temp[] IS NOT INITIAL.
  " Fetch vendor-specific AND mandi-level records
  SELECT *
    FROM zfi_vendcd_term INTO TABLE gt_vendcd_term
    FOR ALL ENTRIES IN gt_bsik_temp
    WHERE bukrs = gt_bsik_temp-bukrs
    AND active = 'X'
    AND ( lifnr = gt_bsik_temp-lifnr OR lifnr = '' ).  " Include blanks

  " Also fetch by company code only (for mandi-level fallback)
  IF sy-subrc = 0.
    DATA: lt_vendcd_add TYPE STANDARD TABLE OF zfi_vendcd_term.
    SELECT *
      FROM zfi_vendcd_term INTO TABLE lt_vendcd_add
      FOR ALL ENTRIES IN gt_bsik_temp
      WHERE bukrs = gt_bsik_temp-bukrs
      AND active = 'X'
      AND lifnr = ''.
    
    APPEND LINES OF lt_vendcd_add TO gt_vendcd_term.
    DELETE ADJACENT DUPLICATES FROM gt_vendcd_term COMPARING ALL FIELDS.
  ENDIF.

  SORT gt_vendcd_term BY bukrs lifnr zp2pdemandi.
ENDIF.












" Get CD Terms from ZFI_VENDCD_TERM
DATA: lv_lifnr_try TYPE lifnr.

CLEAR: gs_vendcd_term, lv_cd_pct, lv_cd_days, lv_grace_days, lv_net_days.

" Priority 1: Exact match with Mandi (BUKRS + LIFNR + MANDI)
READ TABLE gt_vendcd_term INTO gs_vendcd_term
  WITH KEY bukrs       = gs_bsik_temp-bukrs
           lifnr       = gs_bsik_temp-lifnr
           zp2pdemandi = lv_mandi
  BINARY SEARCH.

IF sy-subrc <> 0.
  " Priority 2: Try with internal format (add leading zeros)
  lv_lifnr_try = gs_bsik_temp-lifnr.
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      input  = lv_lifnr_try
    IMPORTING
      output = lv_lifnr_try.
  
  READ TABLE gt_vendcd_term INTO gs_vendcd_term
    WITH KEY bukrs       = gs_bsik_temp-bukrs
             lifnr       = lv_lifnr_try
             zp2pdemandi = lv_mandi
    BINARY SEARCH.
ENDIF.

IF sy-subrc <> 0.
  " Priority 3: Try with external format (remove leading zeros)
  lv_lifnr_try = gs_bsik_temp-lifnr.
  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
    EXPORTING
      input  = lv_lifnr_try
    IMPORTING
      output = lv_lifnr_try.
  
  READ TABLE gt_vendcd_term INTO gs_vendcd_term
    WITH KEY bukrs       = gs_bsik_temp-bukrs
             lifnr       = lv_lifnr_try
             zp2pdemandi = lv_mandi
    BINARY SEARCH.
ENDIF.

IF sy-subrc <> 0.
  " Priority 4: Vendor without Mandi (BUKRS + LIFNR only)
  LOOP AT gt_vendcd_term INTO gs_vendcd_term
    WHERE bukrs = gs_bsik_temp-bukrs
    AND ( lifnr = gs_bsik_temp-lifnr OR lifnr = lv_lifnr_try )
    AND zp2pdemandi = ''.
    EXIT.
  ENDLOOP.
ENDIF.

IF sy-subrc <> 0.
  " Priority 5: Mandi-level (BUKRS + MANDI, blank vendor)
  LOOP AT gt_vendcd_term INTO gs_vendcd_term
    WHERE bukrs       = gs_bsik_temp-bukrs
    AND zp2pdemandi = lv_mandi
    AND lifnr       = ''.
    EXIT.
  ENDLOOP.
ENDIF.

IF sy-subrc = 0.
  " Found terms - populate
  lv_cd_pct     = gs_vendcd_term-cd_percent.
  lv_cd_days    = gs_vendcd_term-cd_days.
  lv_grace_days = gs_vendcd_term-grace_days.
  lv_net_days   = gs_vendcd_term-net_days.
ELSE.
  " No CD terms found - skip this document
  CONTINUE.
ENDIF.
