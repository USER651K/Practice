7" Get CD Terms from ZFI_VENDCD_TERM
      " Priority 1: BUKRS + ZP2PDEMANDI + LIFNR (vendor-specific)
      " Priority 2: BUKRS + ZP2PDEMANDI only (mandi-level default)
      
      DATA: lv_lifnr_alpha TYPE lifnr.
      
      CLEAR: gs_vendcd_term, lv_cd_pct, lv_cd_days, lv_grace_days, lv_net_days.
      
      " Convert vendor to internal format (with leading zeros)
      lv_lifnr_alpha = gs_bsik_temp-lifnr.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = lv_lifnr_alpha
        IMPORTING
          output = lv_lifnr_alpha.
      
      " Priority 1: Match by BUKRS + ZP2PDEMANDI + LIFNR
      " Key order MUST match sort order: bukrs zp2pdemandi lifnr
      READ TABLE gt_vendcd_term INTO gs_vendcd_term
        WITH KEY bukrs       = gs_bsik_temp-bukrs
                 zp2pdemandi = lv_mandi
                 lifnr       = lv_lifnr_alpha
        BINARY SEARCH.
      
      IF sy-subrc = 0.
        " Found vendor + mandi specific terms
        lv_cd_pct     = gs_vendcd_term-cd_percent.
        lv_cd_days    = gs_vendcd_term-cd_days.
        lv_grace_days = gs_vendcd_term-grace_days.
        lv_net_days   = gs_vendcd_term-net_days.
      ELSE.
        " Priority 2: Match by BUKRS + ZP2PDEMANDI only (mandi-level default)
        " This handles records where LIFNR is blank or '*'
        LOOP AT gt_vendcd_term INTO gs_vendcd_term
          WHERE bukrs       = gs_bsik_temp-bukrs
            AND zp2pdemandi = lv_mandi
            AND ( lifnr = space OR lifnr = '*' ).
          EXIT.  " Take first match
        ENDLOOP.
        
        IF sy-subrc = 0.
          " Found mandi-level terms
          lv_cd_pct     = gs_vendcd_term-cd_percent.
          lv_cd_days    = gs_vendcd_term-cd_days.
          lv_grace_days = gs_vendcd_term-grace_days.
          lv_net_days   = gs_vendcd_term-net_days.
        ELSE.
          " No CD terms found - skip this document
          CONTINUE.
        ENDIF.
      ENDIF.




*&---------------------------------------------------------------------*
*& Form CALCULATE_APPLICABLE_CD
*& Formula: Applicable CD% = CD% × (Days / Net)
*&          Applicable CD Amt = Payment Amt × Applicable CD% / 100
*&---------------------------------------------------------------------*
FORM calculate_applicable_cd USING p_zfbdt      TYPE bsik-zfbdt
                                   p_cd_days    TYPE zfi_vendcd_term-cd_days
                                   p_grace_days TYPE zfi_vendcd_term-grace_days
                                   p_cd_pct     TYPE zfi_vendcd_term-cd_percent
                                   p_cd_pct2    TYPE zfi_vendcd_term-cd_percent
                                   p_amount     TYPE bsik-wrbtr
                                   p_net_days   TYPE zfi_vendcd_term-net_days
                          CHANGING p_cd_pct_out TYPE p
                                   p_cd_amt     TYPE bsik-wrbtr.

  DATA: lv_days    TYPE i,
        lv_net     TYPE i,
        lv_cd_pct  TYPE p DECIMALS 3.

  CLEAR: p_cd_pct_out, p_cd_amt.

  " Calculate days from baseline date to today
  lv_days = sy-datum - p_zfbdt.
  
  " Ensure days is positive
  IF lv_days < 0.
    lv_days = 0.
  ENDIF.

  " Get Net Days
  lv_net = p_net_days.
  
  " Prevent division by zero
  IF lv_net <= 0.
    lv_net = 1.
  ENDIF.

  " Formula 1: Applicable CD% = CD% × (Days / Net)
  lv_cd_pct = p_cd_pct * lv_days / lv_net.
  
  " Cap at maximum CD% (cannot exceed original CD%)
  IF lv_cd_pct > p_cd_pct.
    lv_cd_pct = p_cd_pct.
  ENDIF.
  
  p_cd_pct_out = lv_cd_pct.

  " Formula 2: Applicable CD Amt = Payment Amt × Applicable CD% / 100
  p_cd_amt = ( p_amount * lv_cd_pct ) / 100.

ENDFORM.
```

---

## Example Calculation with Your Data:

| Field | Value |
|-------|-------|
| CD% | 2.000 |
| Days | 513 |
| Net Days | 30 |
| Payment Amt | 143,811.00 |

**Calculation:**
```
Applicable CD% = 2.000 × (513 / 30) = 2.000 × 17.1 = 34.2%

BUT with cap at CD% (2.000):
Applicable CD% = 2.000% (capped)

Applicable CD Amt = 143,811.00 × 2.000 / 100 = 2,876.22













WHEN 'PAYMENT_AMT'.
  " Handle PAYMENT_AMT change
  lv_new_amt = ls_mod_cell-value.
  
  " VALIDATION: Payment Amount cannot exceed Initial Amount
  IF lv_new_amt > ls_credit-initial_amt.
    " Show error and reset to initial amount
    CALL METHOD er_data_changed->add_protocol_entry
      EXPORTING
        i_msgid     = '00'
        i_msgno     = '001'
        i_msgty     = 'E'
        i_msgv1     = 'Payment Amount cannot exceed'
        i_msgv2     = 'Initial Amount'
        i_fieldname = 'PAYMENT_AMT'
        i_row_id    = ls_mod_cell-row_id.
    
    " Reset to initial amount
    ls_credit-payment_amt = ls_credit-initial_amt.
  ELSE.
    ls_credit-payment_amt = lv_new_amt.
  ENDIF.
  
  " Recalculate Applicable CD Amount
  PERFORM calculate_applicable_cd
    USING    ls_credit-zfbdt
             ls_credit-cd_days
             ls_credit-grace_days
             ls_credit-cd_pct
             ls_credit-cd_pct
             ls_credit-payment_amt
             ls_credit-net_days
    CHANGING ls_credit-applicable_cd_pct
             ls_credit-applicable_cd_amt.

  MODIFY gt_credit FROM ls_credit INDEX lv_tabix.























FORM post_selected_documents.

  DATA: lv_posted_doc    TYPE belnr_d,
        lv_clear_doc     TYPE belnr_d,
        lv_message       TYPE char100,
        lv_clear_msg     TYPE char100,
        lv_success       TYPE char1,
        lv_clear_success TYPE char1,
        lv_skip_bapi     TYPE char1,
        lt_celltab       TYPE lvc_t_styl,
        ls_celltab       TYPE lvc_s_styl.

  FIELD-SYMBOLS: <fs_credit> TYPE ty_credit.

  CLEAR: gv_post_count, gv_error_count.

  LOOP AT gt_credit ASSIGNING <fs_credit>.

    " Skip if not selected
    IF <fs_credit>-checkmark <> 'X'.
      CONTINUE.
    ENDIF.

    " Skip if fully posted (both BAPI and BDC done)
    IF <fs_credit>-cd_status = 'X' AND <fs_credit>-clg_status = 'X'.
      CONTINUE.
    ENDIF.

    " Validate: Applicable CD Amount must be > 0
    IF <fs_credit>-applicable_cd_amt <= 0.
      <fs_credit>-post_message = 'No CD amount to post'.
      gv_error_count = gv_error_count + 1.
      CONTINUE.
    ENDIF.

    " Validate: Amount After CD must be > 0
    IF <fs_credit>-amt_after_cd <= 0.
      <fs_credit>-post_message = 'No clearing amount'.
      gv_error_count = gv_error_count + 1.
      CONTINUE.
    ENDIF.

    " Clear variables
    CLEAR: lv_posted_doc, lv_clear_doc, lv_message, lv_clear_msg,
           lv_success, lv_clear_success, lv_skip_bapi.

    "------------------------------------------------------------
    " CHECK: Is BAPI already done but BDC pending?
    "------------------------------------------------------------
    IF <fs_credit>-cd_status = 'X' AND <fs_credit>-clg_status <> 'X'.
      " BAPI already done, skip to BDC
      lv_skip_bapi  = 'X'.
      lv_posted_doc = <fs_credit>-cd_doc.
      lv_success    = 'X'.
    ENDIF.

    "------------------------------------------------------------
    " STEP 1: BAPI - Post Debit Note (if not already done)
    "------------------------------------------------------------
    IF lv_skip_bapi <> 'X'.
      PERFORM call_bapi_acc_document_post
        USING    <fs_credit>
        CHANGING lv_posted_doc
                 lv_message
                 lv_success.

      IF lv_success = 'X'.
        " BAPI Success - Update CD fields
        <fs_credit>-cd_status   = 'X'.
        <fs_credit>-cd_doc      = lv_posted_doc.
        <fs_credit>-post_doc_no = lv_posted_doc.
        <fs_credit>-post_message = lv_message.
      ELSE.
        " BAPI Failed
        <fs_credit>-cd_status    = ' '.
        <fs_credit>-post_message = lv_message.
        gv_error_count = gv_error_count + 1.
        CONTINUE.
      ENDIF.
    ENDIF.

    "------------------------------------------------------------
    " STEP 2: BDC F-44 - Clear Vendor
    "------------------------------------------------------------
    PERFORM call_bdc_vendor_clearing
      USING    <fs_credit>
               lv_posted_doc
      CHANGING lv_clear_doc
               lv_clear_msg
               lv_clear_success.

    IF lv_clear_success = 'X'.
      " BDC Success - Update Clearing fields
      <fs_credit>-clg_status      = 'X'.
      <fs_credit>-clg_doc         = lv_clear_doc.
      <fs_credit>-payment_posted  = 'X'.
      <fs_credit>-payment_doc_no  = lv_clear_doc.
      <fs_credit>-payment_message = lv_clear_msg.

      " Mark as fully posted
      <fs_credit>-posted = 'X'.

      " Combined message
      CONCATENATE 'DN:' lv_posted_doc 'CLR:' lv_clear_doc
        INTO <fs_credit>-post_message SEPARATED BY space.

      gv_post_count = gv_post_count + 1.

    ELSE.
      " BDC Failed - But BAPI was successful
      <fs_credit>-clg_status      = ' '.
      <fs_credit>-payment_posted  = ' '.
      <fs_credit>-payment_message = lv_clear_msg.

      " Keep cd_status = 'X' so it can be retried
      CONCATENATE 'DN OK:' lv_posted_doc 'CLR Fail:' lv_clear_msg
        INTO <fs_credit>-post_message SEPARATED BY space.

      " Don't mark as fully posted - allow retry
      <fs_credit>-posted = ' '.

      gv_error_count = gv_error_count + 1.
    ENDIF.

    " Clear checkmark
    <fs_credit>-checkmark = ' '.

    " Update cell styles
    CLEAR lt_celltab.
    IF <fs_credit>-posted = 'X'.
      " Fully posted - disable checkmark
      CLEAR ls_celltab.
      ls_celltab-fieldname = 'CHECKMARK'.
      ls_celltab-style     = cl_gui_alv_grid=>mc_style_disabled.
      APPEND ls_celltab TO lt_celltab.

      CLEAR ls_celltab.
      ls_celltab-fieldname = 'MANUAL_EDIT'.
      ls_celltab-style     = cl_gui_alv_grid=>mc_style_disabled.
      APPEND ls_celltab TO lt_celltab.
    ENDIF.
    <fs_credit>-celltab = lt_celltab.

    " Save to custom table (always save if BAPI succeeded)
    IF <fs_credit>-cd_status = 'X'.
      PERFORM update_vendcd_doc USING <fs_credit>.
    ENDIF.

  ENDLOOP.

ENDFORM.












" Check if Already Posted (fully or partially)
CLEAR gs_vendcd_doc.
READ TABLE gt_vendcd_doc INTO gs_vendcd_doc
  WITH KEY bukrs = gs_bsik_temp-bukrs
           belnr = gs_bsik_temp-belnr
           gjahr = gs_bsik_temp-gjahr
           buzei = gs_bsik_temp-buzei.

IF sy-subrc = 0.
  IF gs_vendcd_doc-cd_status = 'X' AND gs_vendcd_doc-clg_status = 'X'.
    " Fully posted - skip
    gs_credit-posted       = 'X'.
    gs_credit-cd_status    = 'X'.
    gs_credit-cd_doc       = gs_vendcd_doc-cd_doc.
    gs_credit-clg_status   = 'X'.
    gs_credit-clg_doc      = gs_vendcd_doc-clg_doc.
    gs_credit-post_message = 'Already Posted'.
  ELSEIF gs_vendcd_doc-cd_status = 'X' AND gs_vendcd_doc-clg_status <> 'X'.
    " BAPI done, BDC pending - allow retry
    gs_credit-posted       = ' '.
    gs_credit-cd_status    = 'X'.
    gs_credit-cd_doc       = gs_vendcd_doc-cd_doc.
    gs_credit-clg_status   = ' '.
    gs_credit-post_message = 'BDC Pending - Retry'.
  ENDIF.
ELSE.
  gs_credit-posted = ' '.
  CLEAR gs_credit-post_message.
ENDIF.












ELSEIF vbkd-ihrez IS NOT INITIAL.
  " Clear planned GI variables
  CLEAR: gv_planned_gi, gt_planned_gi.
  
  " Step 1: Fetch all VBELN for this IHREZ (can be multiple)
  SELECT vbeln ihrez
    FROM vbkd
    INTO TABLE gt_vbkd
    WHERE ihrez = vbkd-ihrez.
    
  IF sy-subrc EQ 0.
    " Step 2: Fetch WADAT from VBEP for all sales orders
    IF gt_vbkd IS NOT INITIAL.
      SELECT wadat FROM vbep
        INTO TABLE gt_planned_gi
        FOR ALL ENTRIES IN gt_vbkd
        WHERE vbeln = gt_vbkd-vbeln.
      
      " Get earliest WADAT for display
      IF gt_planned_gi IS NOT INITIAL.
        SORT gt_planned_gi.
        READ TABLE gt_planned_gi INTO gv_planned_gi INDEX 1.
      ENDIF.
    ENDIF.
    
    " Existing logic - Fetch delivery documents
    SELECT vbelv vbeln
      FROM vbfa
      INTO TABLE gt_vbfa
      FOR ALL ENTRIES IN gt_vbkd
      WHERE vbelv = gt_vbkd-vbeln
      AND vbtyp_n = 'J'.










ELSEIF vbkd-ihrez IS NOT INITIAL.
  " Clear planned GI variables
  CLEAR: gv_planned_gi, gt_planned_gi.
  
  " Step 1: Fetch all VBELN for this IHREZ
  SELECT vbeln ihrez
    FROM vbkd
    INTO TABLE gt_vbkd
    WHERE ihrez = vbkd-ihrez.
    
  IF sy-subrc EQ 0.
    " Step 2: Fetch WADAT from VBEP for all sales orders
    IF gt_vbkd IS NOT INITIAL.
      SELECT wadat FROM vbep
        INTO TABLE gt_planned_gi
        FOR ALL ENTRIES IN gt_vbkd
        WHERE vbeln = gt_vbkd-vbeln.
      
      " Get earliest WADAT for display
      IF gt_planned_gi IS NOT INITIAL.
        SORT gt_planned_gi.
        READ TABLE gt_planned_gi INTO gv_planned_gi INDEX 1.
      ENDIF.
    ENDIF.
    
    " Existing logic - Fetch delivery documents
    SELECT vbelv vbeln
      FROM vbfa
      INTO TABLE gt_vbfa
      FOR ALL ENTRIES IN gt_vbkd
      WHERE vbelv = gt_vbkd-vbeln
      AND vbtyp_n = 'J'.
  ENDIF.











*&---------------------------------------------------------------------*
*&      Module  HANDLE_SALEORD_CHANGE  INPUT
*&---------------------------------------------------------------------*
*       Handle Sales Order dropdown selection change
*       Updates Planned GI Date immediately on selection
*----------------------------------------------------------------------*
*BOC--UJWAL--02.02.2026
MODULE handle_saleord_change INPUT.
  "Only process for Load Number scenario (IHREZ)
  IF vbkd-ihrez IS NOT INITIAL.
    "Update Planned GI Date when sales order selection changes
    IF sale_ord IS NOT INITIAL AND gt_vbeln_wadat IS NOT INITIAL.
      CLEAR gs_vbeln_wadat.
      READ TABLE gt_vbeln_wadat INTO gs_vbeln_wadat
        WITH KEY vbeln = sale_ord.
      IF sy-subrc = 0.
        gv_planned_gi = gs_vbeln_wadat-wadat.
      ENDIF.
    ENDIF.
  ENDIF.
ENDMODULE.
*EOC--UJWAL--02.02.2026
