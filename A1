" Get CD Terms from ZFI_VENDCD_TERM
      " Priority 1: BUKRS + ZP2PDEMANDI + LIFNR (vendor-specific)
      " Priority 2: BUKRS + ZP2PDEMANDI only (mandi-level default)
      
      DATA: lv_lifnr_alpha TYPE lifnr.
      
      CLEAR: gs_vendcd_term, lv_cd_pct, lv_cd_days, lv_grace_days, lv_net_days.
      
      " Convert vendor to internal format (with leading zeros)
      lv_lifnr_alpha = gs_bsik_temp-lifnr.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = lv_lifnr_alpha
        IMPORTING
          output = lv_lifnr_alpha.
      
      " Priority 1: Match by BUKRS + ZP2PDEMANDI + LIFNR
      " Key order MUST match sort order: bukrs zp2pdemandi lifnr
      READ TABLE gt_vendcd_term INTO gs_vendcd_term
        WITH KEY bukrs       = gs_bsik_temp-bukrs
                 zp2pdemandi = lv_mandi
                 lifnr       = lv_lifnr_alpha
        BINARY SEARCH.
      
      IF sy-subrc = 0.
        " Found vendor + mandi specific terms
        lv_cd_pct     = gs_vendcd_term-cd_percent.
        lv_cd_days    = gs_vendcd_term-cd_days.
        lv_grace_days = gs_vendcd_term-grace_days.
        lv_net_days   = gs_vendcd_term-net_days.
      ELSE.
        " Priority 2: Match by BUKRS + ZP2PDEMANDI only (mandi-level default)
        " This handles records where LIFNR is blank or '*'
        LOOP AT gt_vendcd_term INTO gs_vendcd_term
          WHERE bukrs       = gs_bsik_temp-bukrs
            AND zp2pdemandi = lv_mandi
            AND ( lifnr = space OR lifnr = '*' ).
          EXIT.  " Take first match
        ENDLOOP.
        
        IF sy-subrc = 0.
          " Found mandi-level terms
          lv_cd_pct     = gs_vendcd_term-cd_percent.
          lv_cd_days    = gs_vendcd_term-cd_days.
          lv_grace_days = gs_vendcd_term-grace_days.
          lv_net_days   = gs_vendcd_term-net_days.
        ELSE.
          " No CD terms found - skip this document
          CONTINUE.
        ENDIF.
      ENDIF.




*&---------------------------------------------------------------------*
*& Form CALCULATE_APPLICABLE_CD
*& Formula: Applicable CD% = CD% × (Days / Net)
*&          Applicable CD Amt = Payment Amt × Applicable CD% / 100
*&---------------------------------------------------------------------*
FORM calculate_applicable_cd USING p_zfbdt      TYPE bsik-zfbdt
                                   p_cd_days    TYPE zfi_vendcd_term-cd_days
                                   p_grace_days TYPE zfi_vendcd_term-grace_days
                                   p_cd_pct     TYPE zfi_vendcd_term-cd_percent
                                   p_cd_pct2    TYPE zfi_vendcd_term-cd_percent
                                   p_amount     TYPE bsik-wrbtr
                                   p_net_days   TYPE zfi_vendcd_term-net_days
                          CHANGING p_cd_pct_out TYPE p
                                   p_cd_amt     TYPE bsik-wrbtr.

  DATA: lv_days    TYPE i,
        lv_net     TYPE i,
        lv_cd_pct  TYPE p DECIMALS 3.

  CLEAR: p_cd_pct_out, p_cd_amt.

  " Calculate days from baseline date to today
  lv_days = sy-datum - p_zfbdt.
  
  " Ensure days is positive
  IF lv_days < 0.
    lv_days = 0.
  ENDIF.

  " Get Net Days
  lv_net = p_net_days.
  
  " Prevent division by zero
  IF lv_net <= 0.
    lv_net = 1.
  ENDIF.

  " Formula 1: Applicable CD% = CD% × (Days / Net)
  lv_cd_pct = p_cd_pct * lv_days / lv_net.
  
  " Cap at maximum CD% (cannot exceed original CD%)
  IF lv_cd_pct > p_cd_pct.
    lv_cd_pct = p_cd_pct.
  ENDIF.
  
  p_cd_pct_out = lv_cd_pct.

  " Formula 2: Applicable CD Amt = Payment Amt × Applicable CD% / 100
  p_cd_amt = ( p_amount * lv_cd_pct ) / 100.

ENDFORM.
```

---

## Example Calculation with Your Data:

| Field | Value |
|-------|-------|
| CD% | 2.000 |
| Days | 513 |
| Net Days | 30 |
| Payment Amt | 143,811.00 |

**Calculation:**
```
Applicable CD% = 2.000 × (513 / 30) = 2.000 × 17.1 = 34.2%

BUT with cap at CD% (2.000):
Applicable CD% = 2.000% (capped)

Applicable CD Amt = 143,811.00 × 2.000 / 100 = 2,876.22













WHEN 'PAYMENT_AMT'.
  " Handle PAYMENT_AMT change
  lv_new_amt = ls_mod_cell-value.
  
  " VALIDATION: Payment Amount cannot exceed Initial Amount
  IF lv_new_amt > ls_credit-initial_amt.
    " Show error and reset to initial amount
    CALL METHOD er_data_changed->add_protocol_entry
      EXPORTING
        i_msgid     = '00'
        i_msgno     = '001'
        i_msgty     = 'E'
        i_msgv1     = 'Payment Amount cannot exceed'
        i_msgv2     = 'Initial Amount'
        i_fieldname = 'PAYMENT_AMT'
        i_row_id    = ls_mod_cell-row_id.
    
    " Reset to initial amount
    ls_credit-payment_amt = ls_credit-initial_amt.
  ELSE.
    ls_credit-payment_amt = lv_new_amt.
  ENDIF.
  
  " Recalculate Applicable CD Amount
  PERFORM calculate_applicable_cd
    USING    ls_credit-zfbdt
             ls_credit-cd_days
             ls_credit-grace_days
             ls_credit-cd_pct
             ls_credit-cd_pct
             ls_credit-payment_amt
             ls_credit-net_days
    CHANGING ls_credit-applicable_cd_pct
             ls_credit-applicable_cd_amt.

  MODIFY gt_credit FROM ls_credit INDEX lv_tabix.
