*&---------------------------------------------------------------------*
*& Report ZEARLY_PAYMENT_DISCOUNT
*&---------------------------------------------------------------------*
*& Purpose: Early Payment Discount Calculator with Dual BAPI Processing
*& Developer: Ujwal
*& Date: 16.01.2026  
*& Business Logic: Calculate discount based on payment timing
*&                 BAPI 1: Store discount amount
*&                 BAPI 2: Store net amount after discount
*&---------------------------------------------------------------------*

REPORT zearly_payment_discount.

*----------------------------------------------------------------------*
* Type Declarations
*----------------------------------------------------------------------*
TYPES: BEGIN OF ty_discount_slab,
         days_from   TYPE i,
         days_to     TYPE i,
         discount_pc TYPE p DECIMALS 2,
       END OF ty_discount_slab.

TYPES: BEGIN OF ty_calculation,
         original_amount TYPE p DECIMALS 2,
         payment_days    TYPE i,
         discount_pc     TYPE p DECIMALS 2,
         discount_amount TYPE p DECIMALS 2,
         net_amount      TYPE p DECIMALS 2,
         payment_date    TYPE dats,
         due_date        TYPE dats,
       END OF ty_calculation.

TYPES: BEGIN OF ty_bapi1_data,
         document_no     TYPE belnr_d,
         customer        TYPE kunnr,
         discount_amount TYPE wrbtr,
         discount_pc     TYPE p DECIMALS 2,
         created_date    TYPE dats,
       END OF ty_bapi1_data.

TYPES: BEGIN OF ty_bapi2_data,
         document_no     TYPE belnr_d,
         customer        TYPE kunnr,
         net_amount      TYPE wrbtr,
         original_amount TYPE wrbtr,
         payment_date    TYPE dats,
       END OF ty_bapi2_data.

TYPES: tt_discount_slab TYPE TABLE OF ty_discount_slab,
       tt_bapi1_data    TYPE TABLE OF ty_bapi1_data,
       tt_bapi2_data    TYPE TABLE OF ty_bapi2_data.

*----------------------------------------------------------------------*
* Global Data
*----------------------------------------------------------------------*
DATA: gt_discount_slab TYPE tt_discount_slab,
      gs_calculation   TYPE ty_calculation,
      gt_bapi1_data    TYPE tt_bapi1_data,
      gt_bapi2_data    TYPE tt_bapi2_data,
      gv_success_bapi1 TYPE char1,
      gv_success_bapi2 TYPE char1.

*----------------------------------------------------------------------*
* Selection Screen
*----------------------------------------------------------------------*
SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE TEXT-001.
PARAMETERS: p_amount TYPE p DECIMALS 2 DEFAULT '100000' OBLIGATORY,
            p_docno  TYPE belnr_d DEFAULT '5000000001' OBLIGATORY,
            p_kunnr  TYPE kunnr DEFAULT '1000001' OBLIGATORY,
            p_due    TYPE dats DEFAULT sy-datum OBLIGATORY,
            p_pay    TYPE dats DEFAULT sy-datum OBLIGATORY.
SELECTION-SCREEN END OF BLOCK b1.

SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE TEXT-002.
PARAMETERS: p_test AS CHECKBOX DEFAULT 'X',
            p_both AS CHECKBOX DEFAULT 'X'.
SELECTION-SCREEN END OF BLOCK b2.

*----------------------------------------------------------------------*
* Initialization
*----------------------------------------------------------------------*
INITIALIZATION.
  " Set default payment date to 5 days from today
  p_pay = sy-datum + 5.
  
  " Initialize discount slabs
  PERFORM f_initialize_discount_slabs.

*----------------------------------------------------------------------*
* At Selection Screen
*----------------------------------------------------------------------*
AT SELECTION-SCREEN.
  IF p_pay < p_due.
    MESSAGE 'Payment date cannot be before due date' TYPE 'E'.
  ENDIF.

*----------------------------------------------------------------------*
* Start of Selection  
*----------------------------------------------------------------------*
START-OF-SELECTION.
  PERFORM f_calculate_discount.
  PERFORM f_display_calculation.
  
  IF p_test = ''.
    PERFORM f_process_bapis.
  ELSE.
    PERFORM f_simulate_bapis.
  ENDIF.

*&---------------------------------------------------------------------*
*& Form f_initialize_discount_slabs
*&---------------------------------------------------------------------*
FORM f_initialize_discount_slabs.
  DATA: ls_slab TYPE ty_discount_slab.
  
  " Define discount slabs (customize as needed)
  CLEAR: gt_discount_slab.
  
  " 1-5 days: 10% discount
  ls_slab-days_from = 1.
  ls_slab-days_to = 5.
  ls_slab-discount_pc = '10.00'.
  APPEND ls_slab TO gt_discount_slab.
  
  " 6-10 days: 8% discount  
  ls_slab-days_from = 6.
  ls_slab-days_to = 10.
  ls_slab-discount_pc = '8.00'.
  APPEND ls_slab TO gt_discount_slab.
  
  " 11-15 days: 5% discount
  ls_slab-days_from = 11.
  ls_slab-days_to = 15.
  ls_slab-discount_pc = '5.00'.
  APPEND ls_slab TO gt_discount_slab.
  
  " 16-20 days: 3% discount
  ls_slab-days_from = 16.
  ls_slab-days_to = 20.
  ls_slab-discount_pc = '3.00'.
  APPEND ls_slab TO gt_discount_slab.
  
  " 21-30 days: 1% discount
  ls_slab-days_from = 21.
  ls_slab-days_to = 30.
  ls_slab-discount_pc = '1.00'.
  APPEND ls_slab TO gt_discount_slab.
  
  " 30+ days: 0% discount (no discount)
  ls_slab-days_from = 31.
  ls_slab-days_to = 999.
  ls_slab-discount_pc = '0.00'.
  APPEND ls_slab TO gt_discount_slab.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form f_calculate_discount
*&---------------------------------------------------------------------*
FORM f_calculate_discount.
  DATA: lv_payment_days TYPE i,
        lv_discount_pc  TYPE p DECIMALS 2.
  
  " Calculate payment days
  lv_payment_days = p_pay - p_due.
  
  " Find applicable discount percentage
  PERFORM f_get_discount_percentage USING lv_payment_days 
                                    CHANGING lv_discount_pc.
  
  " Populate calculation structure
  gs_calculation-original_amount = p_amount.
  gs_calculation-payment_days = lv_payment_days.
  gs_calculation-discount_pc = lv_discount_pc.
  gs_calculation-discount_amount = ( p_amount * lv_discount_pc ) / 100.
  gs_calculation-net_amount = p_amount - gs_calculation-discount_amount.
  gs_calculation-payment_date = p_pay.
  gs_calculation-due_date = p_due.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form f_get_discount_percentage
*&---------------------------------------------------------------------*
FORM f_get_discount_percentage USING iv_days TYPE i
                               CHANGING cv_discount_pc TYPE p.
  
  " Find discount percentage based on payment days
  LOOP AT gt_discount_slab INTO DATA(ls_slab).
    IF iv_days >= ls_slab-days_from AND iv_days <= ls_slab-days_to.
      cv_discount_pc = ls_slab-discount_pc.
      EXIT.
    ENDIF.
  ENDLOOP.
  
  " If no slab found, no discount
  IF cv_discount_pc IS INITIAL.
    cv_discount_pc = 0.
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form f_display_calculation
*&---------------------------------------------------------------------*
FORM f_display_calculation.
  
  WRITE: / 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'.
  WRITE: / 'â•‘              EARLY PAYMENT DISCOUNT CALCULATOR      â•‘'.
  WRITE: / 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'.
  SKIP 1.
  
  WRITE: / 'Input Parameters:'.
  WRITE: / '================'.
  WRITE: / 'Document Number    :', p_docno.
  WRITE: / 'Customer           :', p_kunnr.
  WRITE: / 'Original Amount    :', p_amount, 'INR'.
  WRITE: / 'Due Date           :', p_due.
  WRITE: / 'Payment Date       :', p_pay.
  SKIP 1.
  
  WRITE: / 'Calculation Results:'.
  WRITE: / '==================='.
  WRITE: / 'Payment Days       :', gs_calculation-payment_days.
  WRITE: / 'Discount Percentage:', gs_calculation-discount_pc, '%'.
  WRITE: / 'Discount Amount    :', gs_calculation-discount_amount, 'INR'.
  WRITE: / 'Net Amount         :', gs_calculation-net_amount, 'INR'.
  SKIP 1.
  
  WRITE: / 'BAPI Processing:'.
  WRITE: / '==============='.
  IF p_test = 'X'.
    WRITE: / 'Mode               : TEST (Simulation Only)'.
  ELSE.
    WRITE: / 'Mode               : PRODUCTION (Real Processing)'.
  ENDIF.
  
  WRITE: / 'Process Both BAPIs :', p_both.
  SKIP 1.
  
  " Display discount slabs
  WRITE: / 'Available Discount Slabs:'.
  WRITE: / '========================'.
  WRITE: / 'Days Range', 15 'Discount %'.
  WRITE: / sy-uline(30).
  
  LOOP AT gt_discount_slab INTO DATA(ls_slab).
    IF ls_slab-days_to = 999.
      WRITE: / ls_slab-days_from, '+ days', 15 ls_slab-discount_pc, '%'.
    ELSE.
      WRITE: / ls_slab-days_from, '-', ls_slab-days_to, 'days', 15 ls_slab-discount_pc, '%'.
    ENDIF.
  ENDLOOP.
  
  SKIP 2.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form f_process_bapis
*&---------------------------------------------------------------------*
FORM f_process_bapis.
  
  WRITE: / 'ðŸ”„ Processing BAPIs in PRODUCTION mode...'.
  SKIP 1.
  
  " Prepare BAPI 1 data (Discount Amount)
  PERFORM f_prepare_bapi1_data.
  
  " Prepare BAPI 2 data (Net Amount)
  PERFORM f_prepare_bapi2_data.
  
  " Execute BAPI 1
  PERFORM f_execute_bapi1.
  
  IF p_both = 'X' AND gv_success_bapi1 = 'X'.
    " Execute BAPI 2 only if BAPI 1 successful
    PERFORM f_execute_bapi2.
  ENDIF.
  
  " Display results
  PERFORM f_display_bapi_results.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form f_simulate_bapis
*&---------------------------------------------------------------------*
FORM f_simulate_bapis.
  
  WRITE: / 'ðŸ§ª Simulating BAPIs in TEST mode...'.
  SKIP 1.
  
  " Prepare BAPI 1 data (Discount Amount)
  PERFORM f_prepare_bapi1_data.
  
  " Prepare BAPI 2 data (Net Amount) 
  PERFORM f_prepare_bapi2_data.
  
  " Simulate successful processing
  gv_success_bapi1 = 'X'.
  gv_success_bapi2 = 'X'.
  
  WRITE: / 'âœ… BAPI 1 Simulation: SUCCESS'.
  WRITE: / '   â†’ Discount amount stored:', gs_calculation-discount_amount, 'INR'.
  
  IF p_both = 'X'.
    WRITE: / 'âœ… BAPI 2 Simulation: SUCCESS'.
    WRITE: / '   â†’ Net amount stored:', gs_calculation-net_amount, 'INR'.
  ENDIF.
  
  SKIP 1.
  WRITE: / 'ðŸ’¡ This is TEST mode - no actual data posted'.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form f_prepare_bapi1_data
*&---------------------------------------------------------------------*
FORM f_prepare_bapi1_data.
  DATA: ls_bapi1 TYPE ty_bapi1_data.
  
  " Prepare data for BAPI 1 (Discount Amount Storage)
  ls_bapi1-document_no = p_docno.
  ls_bapi1-customer = p_kunnr.
  ls_bapi1-discount_amount = gs_calculation-discount_amount.
  ls_bapi1-discount_pc = gs_calculation-discount_pc.
  ls_bapi1-created_date = sy-datum.
  
  APPEND ls_bapi1 TO gt_bapi1_data.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form f_prepare_bapi2_data
*&---------------------------------------------------------------------*
FORM f_prepare_bapi2_data.
  DATA: ls_bapi2 TYPE ty_bapi2_data.
  
  " Prepare data for BAPI 2 (Net Amount Storage)
  ls_bapi2-document_no = p_docno.
  ls_bapi2-customer = p_kunnr.
  ls_bapi2-net_amount = gs_calculation-net_amount.
  ls_bapi2-original_amount = gs_calculation-original_amount.
  ls_bapi2-payment_date = p_pay.
  
  APPEND ls_bapi2 TO gt_bapi2_data.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form f_execute_bapi1
*&---------------------------------------------------------------------*
FORM f_execute_bapi1.
  " This would be your actual BAPI call for discount amount storage
  " Replace with your specific BAPI
  
  DATA: lt_return TYPE TABLE OF bapiret2.
  
  WRITE: / 'ðŸ“ Executing BAPI 1 (Discount Amount Storage)...'.
  
  " Example BAPI call - replace with your actual BAPI
  " CALL FUNCTION 'BAPI_YOUR_DISCOUNT_STORE'
  "   EXPORTING
  "     document_number = p_docno
  "     customer        = p_kunnr  
  "     discount_amount = gs_calculation-discount_amount
  "     discount_percent = gs_calculation-discount_pc
  "   TABLES
  "     return          = lt_return.
  
  " Simulate successful call for demo
  gv_success_bapi1 = 'X'.
  
  IF gv_success_bapi1 = 'X'.
    WRITE: / 'âœ… BAPI 1 executed successfully'.
    WRITE: / '   Document:', p_docno.
    WRITE: / '   Discount Amount:', gs_calculation-discount_amount, 'INR'.
  ELSE.
    WRITE: / 'âŒ BAPI 1 failed'.
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form f_execute_bapi2
*&---------------------------------------------------------------------*
FORM f_execute_bapi2.
  " This would be your actual BAPI call for net amount storage
  " Replace with your specific BAPI
  
  DATA: lt_return TYPE TABLE OF bapiret2.
  
  WRITE: / 'ðŸ“ Executing BAPI 2 (Net Amount Storage)...'.
  
  " Example BAPI call - replace with your actual BAPI  
  " CALL FUNCTION 'BAPI_YOUR_NET_AMOUNT_STORE'
  "   EXPORTING
  "     document_number = p_docno
  "     customer        = p_kunnr
  "     net_amount      = gs_calculation-net_amount
  "     original_amount = gs_calculation-original_amount
  "     payment_date    = p_pay
  "   TABLES
  "     return          = lt_return.
  
  " Simulate successful call for demo
  gv_success_bapi2 = 'X'.
  
  IF gv_success_bapi2 = 'X'.
    WRITE: / 'âœ… BAPI 2 executed successfully'.
    WRITE: / '   Document:', p_docno.
    WRITE: / '   Net Amount:', gs_calculation-net_amount, 'INR'.
  ELSE.
    WRITE: / 'âŒ BAPI 2 failed'.
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form f_display_bapi_results
*&---------------------------------------------------------------------*
FORM f_display_bapi_results.
  
  SKIP 1.
  WRITE: / 'ðŸ“Š BAPI Processing Summary:'.
  WRITE: / '=========================='.
  
  IF gv_success_bapi1 = 'X'.
    WRITE: / 'BAPI 1 (Discount)   : âœ… SUCCESS'.
  ELSE.
    WRITE: / 'BAPI 1 (Discount)   : âŒ FAILED'.
  ENDIF.
  
  IF p_both = 'X'.
    IF gv_success_bapi2 = 'X'.
      WRITE: / 'BAPI 2 (Net Amount) : âœ… SUCCESS'.
    ELSE.
      WRITE: / 'BAPI 2 (Net Amount) : âŒ FAILED'.
    ENDIF.
  ELSE.
    WRITE: / 'BAPI 2 (Net Amount) : â­ï¸ SKIPPED'.
  ENDIF.
  
  SKIP 1.
  WRITE: / 'ðŸ’¾ Data processed:'.
  WRITE: / '  Discount stored   :', gs_calculation-discount_amount, 'INR'.
  IF p_both = 'X'.
    WRITE: / '  Net amount stored :', gs_calculation-net_amount, 'INR'.
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& User Commands (for interactive testing)
*&---------------------------------------------------------------------*
AT USER-COMMAND.
  CASE sy-ucomm.
    WHEN 'RECALC'.
      " Recalculate with new parameters
      PERFORM f_calculate_discount.
      PERFORM f_display_calculation.
    WHEN 'PROCESS'.
      " Process BAPIs
      IF p_test = ''.
        PERFORM f_process_bapis.
      ELSE.
        PERFORM f_simulate_bapis.
      ENDIF.
  ENDCASE.

*&---------------------------------------------------------------------*
*& Text Elements
*&---------------------------------------------------------------------*
* TEXT-001: Input Parameters
* TEXT-002: Processing Options

*&---------------------------------------------------------------------*
*& End of Program
*&---------------------------------------------------------------------*
