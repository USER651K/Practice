*BOC--UJWAL--02.02.2026
            CLEAR: gv_planned_gi.
              "Sales Order from VBKD using BSTKD (Customer PO)
            SELECT SINGLE vbeln
              FROM vbkd INTO lv_ord
              WHERE bstkd = vbkd-bstkd.

            IF sy-subrc EQ 0.
              wa_ysdssop-sales_order = lv_ord.

              "Delivery from VBFA
              SELECT SINGLE vbeln
                FROM vbfa INTO lv_delivery
                WHERE vbelv = lv_ord
                AND vbtyp_n = 'J'.

              "Planned GI Date (WADAT) from LIKP using Delivery
              IF lv_delivery IS NOT INITIAL.
                SELECT SINGLE wadat
                  FROM likp INTO gv_planned_gi
                  WHERE vbeln = lv_delivery.
              ENDIF.
*EOC--UJWAL--02.02.2026


*BOC--UJWAL--02.02.2026
          CLEAR: gv_planned_gi.
*EOC--UJWAL--02.02.2026
          SELECT SINGLE vbeln
            FROM vbkd INTO lv_ord
            WHERE bstkd = vbkd-bstkd.

          IF sy-subrc EQ 0.
            sale_ord = lv_ord.
            SELECT SINGLE vbeln
              FROM vbfa INTO lv_del
              WHERE vbelv = lv_ord
              AND vbtyp_n = 'J'.
*BOC--UJWAL--02.02.2026
         IF lv_del IS NOT INITIAL.
            SELECT SINGLE wadat
              FROM likp INTO gv_planned_gi
              WHERE vbeln = lv_del.
           ENDIF.
*EOC--UJWAL--02.02.2026



















**BOC--UJWAL--02.02.2026.
          CLEAR: gv_planned_gi, gt_planned_gi, gt_vbeln_wadat.
           "Fetch all VBELN for this IHREZ
           SELECT vbeln ihrez
             FROM vbkd
             INTO TABLE gt_vbkd
             WHERE ihrez = vbkd-ihrez.

           IF sy-subrc EQ 0.
             "Fetch WADAT from VBEP for given vbeln
             IF gt_vbkd IS NOT INITIAL.
               SELECT vbeln wadat
                 FROM vbep
                 INTO TABLE gt_vbeln_wadat
                 FOR ALL ENTRIES IN gt_vbkd
                 WHERE vbeln = gt_vbkd-vbeln.

               "WADAT for display (initial value)
               IF gt_vbeln_wadat IS NOT INITIAL.
                 SORT gt_vbeln_wadat BY vbeln.
                 READ TABLE gt_vbeln_wadat INTO gs_vbeln_wadat INDEX 1.
                  IF sy-subrc = 0.
                    gv_planned_gi = gs_vbeln_wadat-wadat.
                  ENDIF.
               ENDIF.
             ENDIF.

             "Fetch delivery documents
             SELECT vbelv vbeln
               FROM vbfa
               INTO TABLE gt_vbfa
               FOR ALL ENTRIES IN gt_vbkd
               WHERE vbelv = gt_vbkd-vbeln
               AND vbtyp_n = 'J'.
**EOC--UJWAL--02.02.2026.




























""""""""""""""""""""""""""""""""""""""""""Ujwal Start OF CODE 01.12.2025"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
" Collect unique pship values from main table
DATA: lt_pship_range TYPE RANGE OF vbeln,
      ls_pship_range LIKE LINE OF lt_pship_range.

LOOP AT it_vbrp INTO wa_vbrp WHERE pship IS NOT INITIAL.
  ls_pship_range-sign = 'I'.
  ls_pship_range-option = 'EQ'.
  ls_pship_range-low = |{ wa_vbrp-pship ALPHA = IN }|.
  COLLECT ls_pship_range INTO lt_pship_range.
  CLEAR: wa_vbrp, ls_pship_range.
ENDLOOP.

IF lt_pship_range IS NOT INITIAL.

  " Step 1: Get MM Invoice Header from RBKP using pship as reference
  SELECT xblnr belnr gjahr
    FROM rbkp
    INTO TABLE gt_rbkp
    WHERE xblnr IN lt_pship_range.

  IF sy-subrc = 0.
    SORT gt_rbkp BY xblnr belnr gjahr.
    DELETE ADJACENT DUPLICATES FROM gt_rbkp COMPARING xblnr belnr gjahr.
  ENDIF.

  IF gt_rbkp IS NOT INITIAL.

    " Step 2: Get Purchase Order History from EKBE
    SELECT belnr gjahr buzei ebeln ebelp bewtp
      FROM ekbe
      INTO TABLE gt_ekbe
      FOR ALL ENTRIES IN gt_rbkp
      WHERE belnr = gt_rbkp-belnr
        AND gjahr = gt_rbkp-gjahr
        AND bewtp = 'Q'
        AND ebeln NE space.

    IF sy-subrc = 0.
      SORT gt_ekbe BY belnr gjahr ebeln ebelp.
      DELETE ADJACENT DUPLICATES FROM gt_ekbe COMPARING belnr gjahr ebeln ebelp.
    ENDIF.

    IF gt_ekbe IS NOT INITIAL.

      " Step 3: Get PO Items to find Contract Reference
      SELECT ebeln ebelp konnr ktpnr ktmng bednr
        FROM ekpo
        INTO TABLE gt_ekpo
        FOR ALL ENTRIES IN gt_ekbe
        WHERE ebeln = gt_ekbe-ebeln
          AND ebelp = gt_ekbe-ebelp.

      IF sy-subrc = 0.
        SORT gt_ekpo BY ebeln ebelp.

        " Step 4: Get CONTRACT Items (for Quantity)
        SELECT ebeln ebelp konnr ktpnr ktmng bednr
          FROM ekpo
          APPENDING TABLE gt_ekpo
          FOR ALL ENTRIES IN gt_ekpo
          WHERE ebeln = gt_ekpo-konnr
            AND ebelp = gt_ekpo-ktpnr
            AND konnr NE space.

        IF sy-subrc = 0.
          SORT gt_ekpo BY ebeln ebelp.
          DELETE ADJACENT DUPLICATES FROM gt_ekpo COMPARING ebeln ebelp.
        ENDIF.
      ENDIF.

      IF gt_ekpo IS NOT INITIAL.

        " Step 5: Get CONTRACT Headers (for Dates)
        SELECT ebeln bedat kdatb kdate submi
          FROM ekko
          INTO TABLE gt_ekko
          FOR ALL ENTRIES IN gt_ekpo
          WHERE ebeln = gt_ekpo-konnr
            AND konnr NE space.

        IF sy-subrc = 0.
          SORT gt_ekko BY ebeln.
          DELETE ADJACENT DUPLICATES FROM gt_ekko COMPARING ebeln.
        ENDIF.

      ENDIF.
    ENDIF.
  ENDIF.
ENDIF.
""""""""""""""""""""""""""""""""""""""""""Ujwal END OF CODE 01.12.2025"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""





















"""""""""""""""""""""""""""""""START OF ALTERNATIVE LOGIC DATA FETCH - UJWAL 04.02.2026"""""""""""""""""""""""""""""""""
" Collect unique shipment numbers for alternative logic
CLEAR: lt_shipment_range, ls_shipment_range.
LOOP AT it_vbrp INTO wa_vbrp WHERE shipment_no IS NOT INITIAL.
  ls_shipment_range-sign = 'I'.
  ls_shipment_range-option = 'EQ'.
  ls_shipment_range-low = wa_vbrp-shipment_no.
  COLLECT ls_shipment_range INTO lt_shipment_range.
  CLEAR: wa_vbrp, ls_shipment_range.
ENDLOOP.

IF lt_shipment_range IS NOT INITIAL.

  " Step 1: Get Delivery from VTTP using Shipment Number
  SELECT tknum tpnum vbeln
    FROM vttp
    INTO TABLE gt_vttp_alt
    WHERE tknum IN lt_shipment_range.

  IF sy-subrc = 0.
    SORT gt_vttp_alt BY tknum vbeln.
    DELETE ADJACENT DUPLICATES FROM gt_vttp_alt COMPARING tknum vbeln.

    " Step 2: Get Reference Document from LIPS using Delivery
    SELECT vbeln posnr vgbel vgpos
      FROM lips
      INTO TABLE gt_lips_alt
      FOR ALL ENTRIES IN gt_vttp_alt
      WHERE vbeln = gt_vttp_alt-vbeln
        AND vgbel NE space.

    IF sy-subrc = 0.
      SORT gt_lips_alt BY vbeln vgbel vgpos.
      DELETE ADJACENT DUPLICATES FROM gt_lips_alt COMPARING vbeln vgbel vgpos.

      " Step 3: Get Customer PO (BSTKD) from VBKD
      SELECT vbeln posnr bstkd
        FROM vbkd
        INTO TABLE gt_vbkd_alt
        FOR ALL ENTRIES IN gt_lips_alt
        WHERE vbeln = gt_lips_alt-vgbel
          AND posnr = gt_lips_alt-vgpos
          AND bstkd NE space.

      IF sy-subrc = 0.
        SORT gt_vbkd_alt BY vbeln posnr bstkd.
        DELETE ADJACENT DUPLICATES FROM gt_vbkd_alt COMPARING vbeln posnr bstkd.

        " Build intermediate table with EBELN type for FOR ALL ENTRIES
        CLEAR: gt_bstkd_ebeln, gs_bstkd_ebeln.
        LOOP AT gt_vbkd_alt INTO gs_vbkd_alt WHERE bstkd IS NOT INITIAL.
          gs_bstkd_ebeln-ebeln = gs_vbkd_alt-bstkd(10).  "Take first 10 characters
          COLLECT gs_bstkd_ebeln INTO gt_bstkd_ebeln.
          CLEAR: gs_vbkd_alt, gs_bstkd_ebeln.
        ENDLOOP.

        IF gt_bstkd_ebeln IS NOT INITIAL.
          " Step 4: Get Purchase Document details from EKPO using converted BSTKD
          SELECT ebeln ebelp konnr ktpnr ktmng bednr
            FROM ekpo
            INTO TABLE gt_ekpo_alt
            FOR ALL ENTRIES IN gt_bstkd_ebeln
            WHERE ebeln = gt_bstkd_ebeln-ebeln.

          IF sy-subrc = 0.
            SORT gt_ekpo_alt BY ebeln ebelp.

            " Step 5: Get Contract Header details from EKKO
            SELECT ebeln bedat kdatb kdate submi
              FROM ekko
              INTO TABLE gt_ekko_alt
              FOR ALL ENTRIES IN gt_ekpo_alt
              WHERE ebeln = gt_ekpo_alt-konnr.

            IF sy-subrc = 0.
              SORT gt_ekko_alt BY ebeln.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.
ENDIF.
"""""""""""""""""""""""""""""""END OF ALTERNATIVE LOGIC DATA FETCH - UJWAL 04.02.2026"""""""""""""""""""""""""""""""""
