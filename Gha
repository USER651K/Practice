""""""""""""""""""""""""""Start of Ujwal Code 01.12.2025""""""""""""""""""""""""""
" Clear contract fields
CLEAR: wa_vbrp-preship_no, wa_vbrp-belnr2, wa_vbrp-gjahr2, wa_vbrp-ebeln,
       wa_vbrp-ebelp, wa_vbrp-konnr, wa_vbrp-ktpnr, wa_vbrp-bedat,
       wa_vbrp-kdatb, wa_vbrp-kdate, wa_vbrp-ktmng, wa_vbrp-bednr, wa_vbrp-submi.

" Populate preship number (from pship field)
wa_vbrp-preship_no = wa_vbrp-pship.

IF wa_vbrp-pship IS NOT INITIAL.

  " Get MM Invoice header using pship as reference
  READ TABLE gt_rbkp INTO gs_rbkp
    WITH KEY xblnr = wa_vbrp-pship
    BINARY SEARCH.

  IF sy-subrc = 0.
    wa_vbrp-belnr2 = gs_rbkp-belnr.
    wa_vbrp-gjahr2 = gs_rbkp-gjahr.

    " Get Purchase Order from EKBE
    READ TABLE gt_ekbe INTO gs_ekbe
      WITH KEY belnr = gs_rbkp-belnr
               gjahr = gs_rbkp-gjahr
      BINARY SEARCH.

    IF sy-subrc = 0.
      wa_vbrp-ebeln = gs_ekbe-ebeln.
      wa_vbrp-ebelp = gs_ekbe-ebelp.

      " Get PO item to find Contract Reference
      READ TABLE gt_ekpo INTO gs_ekpo
        WITH KEY ebeln = gs_ekbe-ebeln
                 ebelp = gs_ekbe-ebelp
        BINARY SEARCH.

      IF sy-subrc = 0.
        wa_vbrp-konnr = gs_ekpo-konnr.    "Contract Number
        wa_vbrp-ktpnr = gs_ekpo-ktpnr.    "Contract Item Number
        wa_vbrp-bednr = gs_ekpo-bednr.    "Requirement Tracking Number

        " *** NOW GET CONTRACT DETAILS using KONNR/KTPNR ***
        IF gs_ekpo-konnr IS NOT INITIAL.
          
          " Get Contract ITEM details (Quantity)
          READ TABLE gt_ekpo INTO DATA(ls_ekpo_contract)
            WITH KEY ebeln = gs_ekpo-konnr     "Use Contract Number
                     ebelp = gs_ekpo-ktpnr     "Use Contract Item
            BINARY SEARCH.

          IF sy-subrc = 0.
            wa_vbrp-ktmng = ls_ekpo_contract-ktmng.  "Contract Target Quantity ✓
          ENDIF.

          " Get Contract HEADER details (Dates)
          READ TABLE gt_ekko INTO gs_ekko
            WITH KEY ebeln = gs_ekpo-konnr     "Use Contract Number
            BINARY SEARCH.

          IF sy-subrc = 0.
            wa_vbrp-bedat = gs_ekko-bedat.     "Contract Date ✓
            wa_vbrp-kdatb = gs_ekko-kdatb.     "Start Date ✓
            wa_vbrp-kdate = gs_ekko-kdate.     "End Date ✓
            wa_vbrp-submi = gs_ekko-submi.     "Collective Number ✓
          ENDIF.

        ENDIF.

      ENDIF.
    ENDIF.
  ENDIF.
ENDIF.
""""""""""""""""""""""""""End Ujwal Code 01.12.2025""""""""""""""""""""""""""



" Get CD Terms from ZFI_VENDCD_TERM
    " First try: Match by BUKRS + LIFNR + ZP2PDEMANDI (Mandi)
    CLEAR gs_vendcd_term.
    READ TABLE gt_vendcd_term INTO gs_vendcd_term
      WITH KEY bukrs       = gs_bsik_temp-bukrs
               lifnr       = gs_bsik_temp-lifnr
               zp2pdemandi = lv_mandi
      BINARY SEARCH.

    IF sy-subrc = 0.
      " Found with Mandi
      lv_cd_pct     = gs_vendcd_term-cd_percent.
      lv_cd_days    = gs_vendcd_term-cd_days.
      lv_grace_days = gs_vendcd_term-grace_days.
      lv_net_days   = gs_vendcd_term-net_days.
    ELSE.
      " Second try: Match by BUKRS + LIFNR only (without Mandi)
      LOOP AT gt_vendcd_term INTO gs_vendcd_term
        WHERE bukrs = gs_bsik_temp-bukrs
          AND lifnr = gs_bsik_temp-lifnr.
        EXIT.  " Take first match
      ENDLOOP.

      IF sy-subrc = 0.
        lv_cd_pct     = gs_vendcd_term-cd_percent.
        lv_cd_days    = gs_vendcd_term-cd_days.
        lv_grace_days = gs_vendcd_term-grace_days.
        lv_net_days   = gs_vendcd_term-net_days.
      ENDIF.
    ENDIF.









FORM call_bapi_acc_document_post
  USING    ps_credit   TYPE ty_credit
  CHANGING pv_doc_no   TYPE belnr_d
           pv_message  TYPE char100
           pv_success  TYPE char1.

  DATA: lv_item_text TYPE bapiacgl09-item_text,
        lv_fiscyear  TYPE gjahr,
        lv_fiscper   TYPE monat,
        lv_amt_pos   TYPE bapiaccr09-amt_doccur,
        lv_amt_neg   TYPE bapiaccr09-amt_doccur,
        lv_cd_pct    TYPE char10,
        lv_cd_amt    TYPE char20.

  " Clear BAPI structures
  CLEAR: gs_doc_header, gv_obj_key, pv_doc_no, pv_message, pv_success.
  CLEAR: gt_accountgl, gt_accountpay, gt_currencyamt, gt_return.
  REFRESH: gt_accountgl, gt_accountpay, gt_currencyamt, gt_return.

  " Get fiscal year and period
  CALL FUNCTION 'FI_PERIOD_DETERMINE'
    EXPORTING
      i_budat = sy-datum
      i_bukrs = ps_credit-bukrs
    IMPORTING
      e_gjahr = lv_fiscyear
      e_monat = lv_fiscper
    EXCEPTIONS
      OTHERS  = 1.

  IF sy-subrc <> 0.
    lv_fiscyear = sy-datum+0(4).
    lv_fiscper  = sy-datum+4(2).
  ENDIF.

  "------------------------------------------------------------
  " 1. DOCUMENT HEADER
  "------------------------------------------------------------
  gs_doc_header-obj_type   = gc_obj_type.
  gs_doc_header-obj_sys    = sy-sysid.
  gs_doc_header-bus_act    = gc_bus_act.
  gs_doc_header-username   = sy-uname.
  gs_doc_header-header_txt = 'Debit Note for Cash Discount'.
  gs_doc_header-comp_code  = ps_credit-bukrs.
  gs_doc_header-doc_date   = sy-datum.
  gs_doc_header-pstng_date = sy-datum.
  gs_doc_header-fisc_year  = lv_fiscyear.
  gs_doc_header-fis_period = lv_fiscper.
  gs_doc_header-doc_type   = gc_doc_type.
  gs_doc_header-doc_status = '4'.
  
  " REF_DOC_NO - Use XBLNR if available, else BELNR
  IF ps_credit-xblnr IS NOT INITIAL.
    gs_doc_header-ref_doc_no = ps_credit-xblnr.
  ELSE.
    gs_doc_header-ref_doc_no = ps_credit-belnr.
  ENDIF.

  "------------------------------------------------------------
  " 2. ACCOUNTGL (Line 11 - Credit G/L Account)
  "------------------------------------------------------------
  CLEAR gs_accountgl.
  gs_accountgl-itemno_acc = '0000000011'.
  gs_accountgl-gl_account = ps_credit-hkont.
  gs_accountgl-comp_code  = ps_credit-bukrs.
  gs_accountgl-bus_area   = ps_credit-gsber.
  gs_accountgl-pstng_date = sy-datum.
  gs_accountgl-tax_code   = ps_credit-mwskz.
  gs_accountgl-costcenter = ps_credit-kostl.
  gs_accountgl-profit_ctr = ps_credit-prctr.

  " Build item text: "CD on INR <PMNT AMT> @ <CD%>%"
  WRITE ps_credit-payment_amt TO lv_cd_amt LEFT-JUSTIFIED.
  WRITE ps_credit-cd_pct TO lv_cd_pct LEFT-JUSTIFIED.
  CONDENSE: lv_cd_amt NO-GAPS, lv_cd_pct NO-GAPS.
  CONCATENATE 'CD on INR' lv_cd_amt '@' lv_cd_pct '%'
    INTO gs_accountgl-item_text SEPARATED BY space.

  APPEND gs_accountgl TO gt_accountgl.

  "------------------------------------------------------------
  " 3. ACCOUNTPAYABLE (Line 10 - Debit Vendor)
  "------------------------------------------------------------
  CLEAR gs_accountpay.
  gs_accountpay-itemno_acc = '0000000010'.
  gs_accountpay-vendor_no  = ps_credit-lifnr.
  gs_accountpay-comp_code  = ps_credit-bukrs.
  gs_accountpay-bus_area   = ps_credit-gsber.
  gs_accountpay-pmnttrms   = ps_credit-payment_term.
  gs_accountpay-bline_date = sy-datum.

  " Item text with reference document
  IF ps_credit-xblnr IS NOT INITIAL.
    CONCATENATE 'Cash Discount Against Doc' ps_credit-xblnr
      INTO gs_accountpay-item_text SEPARATED BY space.
  ELSE.
    CONCATENATE 'Cash Discount Against Doc' ps_credit-belnr
      INTO gs_accountpay-item_text SEPARATED BY space.
  ENDIF.

  APPEND gs_accountpay TO gt_accountpay.

  "------------------------------------------------------------
  " 4. CURRENCYAMOUNT (2 Lines)
  "------------------------------------------------------------
  " Line 10 - Debit Vendor (Positive)
  CLEAR gs_currencyamt.
  gs_currencyamt-itemno_acc   = '0000000010'.
  gs_currencyamt-currency     = ps_credit-waers.
  gs_currencyamt-currency_iso = ps_credit-waers.
  lv_amt_pos = ps_credit-payment_amt.
  gs_currencyamt-amt_doccur   = lv_amt_pos.
  APPEND gs_currencyamt TO gt_currencyamt.

  " Line 11 - Credit G/L (Negative)
  CLEAR gs_currencyamt.
  gs_currencyamt-itemno_acc   = '0000000011'.
  gs_currencyamt-currency     = ps_credit-waers.
  gs_currencyamt-currency_iso = ps_credit-waers.
  lv_amt_neg = ps_credit-payment_amt * -1.
  gs_currencyamt-amt_doccur   = lv_amt_neg.
  APPEND gs_currencyamt TO gt_currencyamt.

  "------------------------------------------------------------
  " 5. CALL BAPI
  "------------------------------------------------------------
  CALL FUNCTION 'BAPI_ACC_DOCUMENT_POST'
    EXPORTING
      documentheader = gs_doc_header
    IMPORTING
      obj_key        = gv_obj_key
    TABLES
      accountgl      = gt_accountgl
      accountpayable = gt_accountpay
      currencyamount = gt_currencyamt
      return         = gt_return.

  "------------------------------------------------------------
  " 6. CHECK RESULT
  "------------------------------------------------------------
  " Check for Error messages
  CLEAR gs_return.
  READ TABLE gt_return INTO gs_return WITH KEY type = 'E'.
  IF sy-subrc = 0.
    pv_message = gs_return-message.
    pv_success = ' '.
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
    RETURN.
  ENDIF.

  " Check for Abort messages
  CLEAR gs_return.
  READ TABLE gt_return INTO gs_return WITH KEY type = 'A'.
  IF sy-subrc = 0.
    pv_message = gs_return-message.
    pv_success = ' '.
    CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
    RETURN.
  ENDIF.

  " Success - Commit
  CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
    EXPORTING
      wait = 'X'.

  " Extract document number from obj_key
  " Format: BUKRS(4) + BELNR(10) + GJAHR(4)
  pv_doc_no = gv_obj_key+4(10).
  CONCATENATE 'Document' pv_doc_no 'posted'
    INTO pv_message SEPARATED BY space.
  pv_success = 'X'.

ENDFORM.
